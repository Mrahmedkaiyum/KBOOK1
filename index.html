<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á - Professional Private Messenger</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --red-main: #D32F2F;
            --red-light: #FFEBEE;
            --whatsapp-green: #25D366;
            --bg-dark: #121212;
            --text-gray: #757575;
            --chat-bg: #E5DDD5;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            background: var(--bg-dark); 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden;
        }

        /* ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
        #app-wrap { 
            width: 100%; 
            max-width: 400px; 
            height: 100vh; 
            background: #fff; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        @media (min-width: 500px) {
            #app-wrap { height: 92vh; border-radius: 20px; }
        }

        /* ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ */
        .screen { 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            text-align: center; 
            position: absolute; 
            inset: 0; 
            background: #fff; 
            z-index: 10; 
            display: none; 
            transition: 0.3s;
        }

        /* ‡¶≤‡ßã‡¶ó‡ßã ‡¶è‡¶¨‡¶Ç ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .logo-main { width: 110px; height: 110px; border-radius: 50%; border: 4px solid var(--red-main); margin-bottom: 20px; object-fit: cover; }
        
        input { 
            width: 100%; 
            padding: 14px 20px; 
            margin: 10px 0; 
            border: 1.5px solid #eee; 
            border-radius: 30px; 
            outline: none; 
            text-align: center; 
            font-size: 16px; 
            background: #fafafa;
        }

        input:focus { border-color: var(--red-main); background: #fff; }

        .btn-primary { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 30px; 
            background: var(--red-main); 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(211,47,47,0.3);
        }

        .btn-primary:active { transform: scale(0.98); }

        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        header { 
            background: var(--red-main); 
            color: white; 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .user-profile-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; background: #eee; cursor: pointer; }

        /* ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü */
        #chat-list { flex: 1; overflow-y: auto; background: #fff; }
        .contact-card { 
            padding: 15px 20px; 
            border-bottom: 1px solid #f5f5f5; 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .contact-card:hover { background: #fcfcfc; }
        .contact-info { margin-left: 15px; text-align: left; }
        .contact-name { font-weight: bold; font-size: 16px; color: #333; display: block; }
        .contact-status { font-size: 12px; color: var(--text-gray); }

        /* ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ */
        #msg-box { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            background: var(--chat-bg); 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }

        .bubble { 
            padding: 10px 15px; 
            border-radius: 18px; 
            max-width: 85%; 
            font-size: 15px; 
            line-height: 1.4; 
            position: relative;
            word-wrap: break-word;
        }
        .bubble.me { background: #DCF8C6; align-self: flex-end; border-bottom-right-radius: 2px; color: #303030; }
        .bubble.you { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; color: #303030; }

        /* ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶è‡¶∞‡¶ø‡ßü‡¶æ */
        .chat-footer { padding: 10px 15px; background: #f0f0f0; display: flex; align-items: center; gap: 10px; }
        .chat-footer input { text-align: left; margin: 0; flex: 1; padding: 12px 18px; background: #fff; border: 1px solid #ddd; }
        .send-btn { 
            background: var(--red-main); 
            color: #fff; 
            border: none; 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
        }

        /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¨‡¶æ‡¶ü‡¶® */
        .fab { 
            position: absolute; 
            bottom: 30px; 
            right: 25px; 
            width: 60px; 
            height: 60px; 
            background: var(--red-main); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 30px; 
            cursor: pointer; 
            box-shadow: 0 5px 20px rgba(211,47,47,0.4); 
            z-index: 15;
        }

        /* ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶∏‡ßç‡¶™‡ßá‡¶∂‡¶æ‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® */
        .wa-link { 
            margin-top: 20px; 
            color: var(--whatsapp-green); 
            text-decoration: none; 
            font-weight: bold; 
            font-size: 13px; 
            border: 1px solid var(--whatsapp-green); 
            padding: 8px 15px; 
            border-radius: 20px; 
        }
    </style>
</head>
<body>

<div id="app-wrap">
    
    <div id="login-screen" class="screen" style="display: flex;">
        <img src="https://i.ibb.co/Zz0WvY9/cat-logo.jpg" class="logo-main">
        <h2 style="color:var(--red-main); margin-bottom:5px;">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</h2>
        <p style="color:var(--text-gray); margin-bottom:20px; font-size:14px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡ßü‡¶§‡¶æ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡¶æ‡ßü‡¶ø‡¶§‡ßç‡¶¨</p>
        <input type="number" id="l-ph" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
        <input type="password" id="l-ps" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
        <button class="btn-primary" onclick="doLogin()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <div style="margin-top:20px;">
            <span class="contact-status" style="cursor:pointer" onclick="showForgot()">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</span> | 
            <span class="contact-status" style="cursor:pointer; color:var(--red-main)" onclick="showReg()">‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</span>
        </div>
    </div>

    <div id="reg-screen" class="screen">
        <h2 style="color:var(--red-main)">‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</h2>
        <input type="text" id="r-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
        <input type="number" id="r-ph" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
        <input type="password" id="r-ps" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">
        <button class="btn-primary" onclick="startReg()">‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        <p class="contact-status" style="margin-top:20px; cursor:pointer" onclick="showLogin()">‡¶™‡¶ø‡¶õ‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</p>
    </div>

    <div id="otp-screen" class="screen">
        <h2 style="color:var(--red-main)">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h2>
        <p id="otp-msg" style="font-size:14px; color:#555;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§</p>
        <input type="number" id="otp-val" placeholder="‡ß™ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®">
        <button class="btn-primary" onclick="verifyOTP()">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px; width:100%;">
            <p style="font-size:11px; color:#999;">‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶π‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <a href="https://wa.me/9660558687975" target="_blank" class="wa-link">üí¨ WhatsApp Admin</a>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <h2 style="color:var(--red-main)">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
        <img id="edit-preview" src="" class="logo-main">
        <input type="text" id="edit-name" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ">
        <input type="text" id="edit-pic" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">
        <button class="btn-primary" onclick="updateProfile()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="btn-primary" style="background:#888;" onclick="hideScreens(); document.getElementById('main-app').style.display='flex';">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
    </div>

    <div id="main-app" style="display:none; flex-direction:column; height:100%;">
        <header>
            <div style="display:flex; align-items:center;" onclick="showProfileEdit()">
                <img id="my-header-img" src="" class="user-profile-img">
                <div style="margin-left:12px;">
                    <span id="my-header-name" style="font-weight:bold; display:block; font-size:15px;">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</span>
                    <span style="font-size:10px; opacity:0.8;">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</span>
                </div>
            </div>
            <div onclick="logout()" style="cursor:pointer; font-size:13px; font-weight:bold;">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</div>
        </header>
        
        <div id="chat-list"></div>
        
        <div class="fab" onclick="addNewContact()">+</div>
    </div>

    <div id="chat-window" style="display:none; flex-direction:column; height:100%; position:absolute; inset:0; background:#fff; z-index:100;">
        <header>
            <div style="display:flex; align-items:center;">
                <span onclick="closeChat()" style="cursor:pointer; font-size:24px; margin-right:15px;">‚Üê</span>
                <img id="target-img" src="" class="user-profile-img">
                <div style="margin-left:12px;">
                    <span id="target-name" style="font-weight:bold; font-size:15px; display:block;">‡¶®‡¶æ‡¶Æ...</span>
                    <span id="target-phone" style="font-size:10px; opacity:0.8;">‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</span>
                </div>
            </div>
        </header>
        
        <div id="msg-box"></div>
        
        <div class="chat-footer">
            <input type="text" id="m-input" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
            <button class="send-btn" onclick="sendMessage()">üöÄ</button>
        </div>
    </div>

</div>

<script>
    // --- ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ---
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡¶∏ ---
    const DEFAULT_CAT = "https://i.ibb.co/Zz0WvY9/cat-logo.jpg";
    let myPhone = localStorage.getItem("lb_phone") || "";
    let activeChat = ""; 
    let flow = ""; // 'reg' or 'forgot'
    let tempUserData = {};

    // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ
    if(myPhone) {
        startApp();
    } else {
        showLogin();
    }

    // --- ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏ ---

    function showLogin() { hideScreens(); document.getElementById('login-screen').style.display='flex'; }
    function showReg() { hideScreens(); document.getElementById('reg-screen').style.display='flex'; }
    function hideScreens() { document.querySelectorAll('.screen').forEach(s => s.style.display='none'); }

    // ‡¶≤‡¶ó‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
    function doLogin() {
        let p = document.getElementById('l-ph').value;
        let s = document.getElementById('l-ps').value;
        if(!p || !s) return alert("‡¶∏‡¶¨ ‡¶ò‡¶∞ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!");
        
        db.ref('users/' + p).once('value', snap => {
            if(!snap.exists()) return alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á!");
            if(snap.val().pass === s) {
                localStorage.setItem("lb_phone", p);
                location.reload();
            } else {
                alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!");
            }
        });
    }

    // ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ (‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶∂‡¶®)
    function startReg() {
        let n = document.getElementById('r-name').value;
        let p = document.getElementById('r-ph').value;
        let s = document.getElementById('r-ps').value;

        if(!n || p.length < 10 || !s) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!");

        db.ref('users/' + p).once('value', snap => {
            if(snap.exists()) return alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶Ö‡¶≤‡¶∞‡ßá‡¶°‡¶ø ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá!");
            
            flow = "reg";
            tempUserData = { name: n, phone: p, pass: s };
            generateOTP(p);
        });
    }

    // ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶≤‡ßá
    function showForgot() {
        let p = document.getElementById('l-ph').value;
        if(!p) return alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        
        db.ref('users/' + p).once('value', snap => {
            if(!snap.exists()) return alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á!");
            flow = "forgot";
            tempUserData = { phone: p };
            generateOTP(p);
        });
    }

    // ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶ì ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞ ‡¶Ö‡¶ü‡ßã-‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
    function generateOTP(phone) {
        let code = Math.floor(1000 + Math.random() * 9000).toString();
        let otpRef = db.ref('admin_otp/' + phone);
        
        otpRef.set({
            code: code,
            type: flow,
            timestamp: Date.now()
        });

        // ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü (‡ß©‡ß¶‡ß¶,‡ß¶‡ß¶‡ß¶ ‡¶Æ‡¶ø.‡¶∏‡ßá.) ‡¶™‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
        setTimeout(() => { otpRef.remove(); }, 300000);

        hideScreens();
        document.getElementById('otp-screen').style.display='flex';
    }

    // ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
    function verifyOTP() {
        let inputCode = document.getElementById('otp-val').value;
        db.ref('admin_otp/' + tempUserData.phone).once('value', snap => {
            if(snap.exists() && snap.val().code === inputCode) {
                if(flow === "reg") {
                    db.ref('users/' + tempUserData.phone).set({
                        name: tempUserData.name,
                        pass: tempUserData.pass,
                        profilePic: DEFAULT_CAT,
                        status: 'online'
                    });
                    localStorage.setItem("lb_phone", tempUserData.phone);
                    location.reload();
                } else {
                    let newPass = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:");
                    if(newPass) {
                        db.ref('users/' + tempUserData.phone).update({ pass: newPass });
                        alert("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                        location.reload();
                    }
                }
            } else {
                alert("‡¶≠‡ßÅ‡¶≤ ‡¶ï‡ßã‡¶° ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø‡¶∞ ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑!");
            }
        });
    }

    // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡¶æ‡¶∞‡ßç‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ
    function startApp() {
        hideScreens();
        document.getElementById('main-app').style.display='flex';
        
        // ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶°
        db.ref('users/' + myPhone).on('value', snap => {
            let data = snap.val();
            document.getElementById('my-header-img').src = data.profilePic || DEFAULT_CAT;
            document.getElementById('my-header-name').innerText = data.name || myPhone;
        });

        loadContacts();
    }

    // ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° (‡¶®‡ßá‡¶Æ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∏‡¶π)
    function loadContacts() {
        db.ref('my_contacts/' + myPhone).on('value', snap => {
            let listDiv = document.getElementById('chat-list');
            listDiv.innerHTML = "";
            
            if(!snap.exists()) {
                listDiv.innerHTML = "<p style='text-align:center; color:#999; margin-top:50px;'>‡¶ï‡ßã‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶®‡ßá‡¶á‡•§ '+' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>";
                return;
            }

            snap.forEach(child => {
                let contactPhone = child.key;
                db.ref('users/' + contactPhone).on('value', uSnap => {
                    let uData = uSnap.val();
                    if(!uData) return;

                    // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá
                    let existing = document.getElementById('card-' + contactPhone);
                    let html = `
                        <div class="contact-card" id="card-${contactPhone}" onclick="openChatWindow('${contactPhone}')">
                            <div class="img-box">
                                <img src="${uData.profilePic || DEFAULT_CAT}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                            </div>
                            <div class="contact-info">
                                <span class="contact-name">${uData.name || contactPhone}</span>
                                <span class="contact-status">${contactPhone}</span>
                            </div>
                        </div>
                    `;
                    
                    if(existing) {
                        existing.outerHTML = html;
                    } else {
                        listDiv.innerHTML += html;
                    }
                });
            });
        });
    }

    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶ì‡¶™‡ßá‡¶®
    function openChatWindow(phone) {
        activeChat = phone;
        document.getElementById('chat-window').style.display = 'flex';
        
        db.ref('users/' + phone).once('value', snap => {
            let d = snap.val();
            document.getElementById('target-name').innerText = d.name || phone;
            document.getElementById('target-phone').innerText = phone;
            document.getElementById('target-img').src = d.profilePic || DEFAULT_CAT;
        });

        listenMessages();
    }

    // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ü‡¶¶‡¶æ‡¶®-‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® (Encryption ‡¶∏‡¶π)
    function sendMessage() {
        let text = document.getElementById('m-input').value;
        if(!text) return;

        let chatID = [myPhone, activeChat].sort().join("_");
        
        // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶®‡¶ï‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá (‡¶ó‡ßã‡¶™‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
        let encodedMsg = btoa(unescape(encodeURIComponent(text)));

        db.ref('chats/' + chatID).push({
            sender: myPhone,
            msg: encodedMsg,
            time: Date.now()
        });

        // ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        db.ref('my_contacts/' + myPhone + '/' + activeChat).set(true);
        db.ref('my_contacts/' + activeChat + '/' + myPhone).set(true);

        document.getElementById('m-input').value = "";
    }

    function listenMessages() {
        let chatID = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + chatID).off();
        db.ref('chats/' + chatID).on('value', snap => {
            let box = document.getElementById('msg-box');
            box.innerHTML = "";
            snap.forEach(m => {
                let d = m.val();
                let side = d.sender === myPhone ? 'me' : 'you';
                
                // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶ï‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                let decodedMsg = decodeURIComponent(escape(atob(d.msg)));
                
                box.innerHTML += `<div class="bubble ${side}">${decodedMsg}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    function showProfileEdit() {
        hideScreens();
        document.getElementById('profile-screen').style.display = 'flex';
        db.ref('users/' + myPhone).once('value', snap => {
            let d = snap.val();
            document.getElementById('edit-name').value = d.name || "";
            document.getElementById('edit-preview').src = d.profilePic || DEFAULT_CAT;
        });
    }

    function updateProfile() {
        let newName = document.getElementById('edit-name').value;
        let newPic = document.getElementById('edit-pic').value;
        
        let updates = { name: newName };
        if(newPic) updates.profilePic = newPic;

        db.ref('users/' + myPhone).update(updates).then(() => {
            alert("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            hideScreens();
            document.getElementById('main-app').style.display = 'flex';
        });
    }

    // ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø
    function closeChat() { document.getElementById('chat-window').style.display = 'none'; }
    
    function addNewContact() {
        let p = prompt("‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if(p && p !== myPhone) {
            db.ref('users/' + p).once('value', snap => {
                if(snap.exists()) {
                    db.ref('my_contacts/' + myPhone + '/' + p).set(true);
                    openChatWindow(p);
                } else {
                    alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á!");
                }
            });
        }
    }

    function logout() {
        if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>
