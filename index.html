<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lal Bilai - Messenger Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --main: #25D366; --dark: #075E54; --bg: #ffffff; --chat-bg: #e5ddd5; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶π‡¶æ‡¶á‡¶ü ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶ñ‡¶æ‡¶ü‡ßã ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ */
        body { margin: 0; background: #222; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #app-wrap { width: 100%; max-width: 400px; height: 92vh; background: var(--bg); position: relative; display: flex; flex-direction: column; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* Auth UI */
        .auth-box { position: absolute; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; padding: 30px; align-items: center; justify-content: center; }
        .logo { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--main); margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; outline: none; background: #f9f9f9; }
        .btn { width: 100%; padding: 12px; background: var(--main); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Header */
        header { background: var(--dark); color: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        .p-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        
        /* Chat List */
        #chat-list { flex: 1; overflow-y: auto; background: white; }
        .user-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }

        /* Inbox Overlay */
        #inbox { position: absolute; inset: 0; background: var(--chat-bg); z-index: 200; display: none; flex-direction: column; }
        #msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 6px; }
        
        /* Message Bubbles & Ticks */
        .m-bubble { max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 14px; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; }
        .rec { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
        .tick { font-size: 10px; margin-left: 5px; color: #888; float: right; margin-top: 5px; }

        .input-bar { padding: 10px; background: #f0f0f0; display: flex; gap: 8px; align-items: center; }
        .input-bar input { margin-bottom: 0; border-radius: 20px; background: white; flex: 1; }
        .send-btn { width: 45px; height: 45px; background: var(--dark); color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .typing-text { font-size: 11px; color: #9dffb0; font-style: italic; display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app-wrap">
    <div id="scr-login" class="auth-box hidden">
        <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="logo">
        <input type="number" id="l-ph" placeholder="Phone Number">
        <input type="password" id="l-ps" placeholder="Password">
        <button class="btn" onclick="handleLogin()">Login</button>
        <p onclick="showAuth('reg')" style="cursor:pointer; font-size:13px; color:var(--dark); margin-top:10px;">Create Account</p>
    </div>

    <div id="scr-reg" class="auth-box hidden">
        <input type="text" id="r-name" placeholder="Full Name">
        <input type="number" id="r-ph" placeholder="Phone Number">
        <input type="password" id="r-ps" placeholder="Password">
        <button class="btn" onclick="requestOTP()">Next (Get OTP)</button>
        <p onclick="showAuth('login')" style="cursor:pointer; font-size:13px; margin-top:10px;">Already have an account?</p>
    </div>

    <div id="scr-main" style="display:none; flex-direction:column; height:100%;">
        <header>
            <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="p-img">
            <span style="flex:1; font-weight:bold;">Lal Bilai</span>
            <span onclick="addNew()" style="font-size:20px; cursor:pointer;">‚ûï</span>
            <span onclick="logout()" style="font-size:18px; cursor:pointer; margin-left:10px;">üö™</span>
        </header>
        <div id="chat-list"></div>
    </div>

    <div id="inbox">
        <header>
            <span onclick="closeInbox()" style="cursor:pointer;">‚¨ÖÔ∏è</span>
            <img id="inbox-img" src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="p-img">
            <div style="flex:1">
                <div id="inbox-name" style="font-size:15px; font-weight:bold;">Name</div>
                <div id="typing-ui" class="typing-text">typing...</div>
            </div>
        </header>
        <div id="msg-area"></div>
        <div class="input-bar">
            <input type="text" id="m-input" placeholder="Type message..." oninput="updateTypingStatus()">
            <button class="send-btn" onclick="sendMsg()">‚û§</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myPhone = localStorage.getItem("lb_phone") ? atob(localStorage.getItem("lb_phone")) : null;
    let activeChat = null;
    let typingTimer;

    function showAuth(mode) {
        document.getElementById('scr-login').classList.toggle('hidden', mode !== 'login');
        document.getElementById('scr-reg').classList.toggle('hidden', mode !== 'reg');
    }

    // Auth & Logic
    function handleLogin() {
        const ph = document.getElementById('l-ph').value;
        const ps = document.getElementById('l-ps').value;
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists() && snap.val().pass === ps) {
                localStorage.setItem("lb_phone", btoa(ph));
                location.reload();
            } else alert("Wrong details!");
        });
    }

    function requestOTP() {
        const name = document.getElementById('r-name').value;
        const ph = document.getElementById('r-ph').value;
        const ps = document.getElementById('r-ps').value;
        if(!name || ph.length < 10 || !ps) return alert("Fill all info!");
        // ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶ø‡¶Æ‡ßç‡¶™‡¶≤ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶Æ‡¶§‡ßã
        db.ref('users/' + btoa(ph)).set({ name, ph, pass: ps }).then(() => {
            localStorage.setItem("lb_phone", btoa(ph));
            location.reload();
        });
    }

    if(!myPhone) { showAuth('login'); } 
    else {
        document.getElementById('scr-main').style.display = 'flex';
        db.ref('status/' + btoa(myPhone)).set(true);
        db.ref('status/' + btoa(myPhone)).onDisconnect().set(false);
        loadChatList();
    }

    function addNew() {
        const ph = prompt("Enter Friend Phone:");
        if(!ph || ph === myPhone) return;
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists()) {
                db.ref('contacts/' + btoa(myPhone) + '/' + btoa(ph)).set({ name: snap.val().name, phone: ph, last: Date.now() });
                openInbox(ph, snap.val().name);
            } else alert("User not found!");
        });
    }

    function loadChatList() {
        db.ref('contacts/' + btoa(myPhone)).orderByChild('last').on('value', snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            let rows = [];
            snap.forEach(c => rows.unshift(c.val()));
            rows.forEach(u => {
                list.innerHTML += `<div class="user-row" onclick="openInbox('${u.phone}', '${u.name}')">
                    <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="p-img">
                    <div style="margin-left:12px;"><b>${u.name}</b><br><small>${u.phone}</small></div>
                </div>`;
            });
        });
    }

    function openInbox(ph, name) {
        activeChat = ph;
        document.getElementById('inbox-name').innerText = name;
        document.getElementById('inbox').style.display = 'flex';
        
        // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶ö‡ßá‡¶ï
        db.ref('typing/' + btoa(ph) + '/' + btoa(myPhone)).on('value', snap => {
            document.getElementById('typing-ui').style.display = snap.val() ? 'block' : 'none';
        });

        // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ì ‡¶ü‡¶ø‡¶ï ‡¶ö‡¶ø‡¶π‡ßç‡¶®
        const chatID = [myPhone, ph].sort().join("_");
        db.ref('messages/' + chatID).on('value', snap => {
            const area = document.getElementById('msg-area');
            area.innerHTML = "";
            snap.forEach(mNode => {
                const m = mNode.val();
                const isMe = m.sender === myPhone;
                area.innerHTML += `<div class="m-bubble ${isMe ? 'sent' : 'rec'}">
                    ${m.text}
                    <span class="tick">${isMe ? '‚úî‚úî' : ''}</span>
                </div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function updateTypingStatus() {
        db.ref('typing/' + btoa(myPhone) + '/' + btoa(activeChat)).set(true);
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            db.ref('typing/' + btoa(myPhone) + '/' + btoa(activeChat)).set(false);
        }, 2000);
    }

    function sendMsg() {
        const txt = document.getElementById('m-input').value;
        if(!txt || !activeChat) return;
        const chatID = [myPhone, activeChat].sort().join("_");
        db.ref('messages/' + chatID).push({ sender: myPhone, text: txt, time: Date.now() });
        db.ref('contacts/' + btoa(myPhone) + '/' + btoa(activeChat)).update({ last: Date.now() });
        document.getElementById('m-input').value = "";
        db.ref('typing/' + btoa(myPhone) + '/' + btoa(activeChat)).set(false);
    }

    function closeInbox() { document.getElementById('inbox').style.display = 'none'; activeChat = null; }
    function logout() { db.ref('status/' + btoa(myPhone)).set(false); localStorage.clear(); location.reload(); }
</script>
</body>
</html>
