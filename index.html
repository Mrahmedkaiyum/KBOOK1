<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lal Bilai - Ultimate Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --main: #25D366; --dark: #075E54; --bg: #ffffff; --chat-bg: #e5ddd5; --light-gray: #f0f0f0; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { margin: 0; background: #121212; height: 100vh; display: flex; align-items: center; justify-content: center; }
        #app-wrap { width: 100%; max-width: 450px; height: 95vh; background: var(--bg); position: relative; display: flex; flex-direction: column; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        /* --- AUTHENTICATION SCREENS --- */
        .auth-overlay { position: absolute; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; padding: 40px 25px; align-items: center; text-align: center; }
        .logo-large { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--main); margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .auth-title { font-size: 24px; color: var(--dark); font-weight: bold; margin-bottom: 20px; }
        
        input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 12px; outline: none; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--main); background: #f9f9f9; }
        .btn-main { width: 100%; padding: 15px; background: var(--main); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 17px; cursor: pointer; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); }
        .btn-secondary { background: none; border: none; color: var(--dark); margin-top: 15px; cursor: pointer; font-size: 14px; text-decoration: underline; }

        /* --- MAIN UI --- */
        header { background: var(--dark); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; height: 70px; z-index: 10; }
        .header-title { flex: 1; font-size: 20px; font-weight: bold; }
        .profile-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; }

        #chat-list { flex: 1; overflow-y: auto; background: white; }
        .user-card { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f2f2f2; cursor: pointer; transition: 0.2s; }
        .user-card:active { background: #ececec; }
        .user-info { margin-left: 15px; flex: 1; }
        .user-info b { font-size: 17px; display: block; }
        .user-info small { color: #777; font-size: 13px; }
        .online-dot { width: 12px; height: 12px; border-radius: 50%; background: #ccc; border: 2px solid white; }
        .online-dot.active { background: var(--main); }

        /* --- INBOX INTERFACE --- */
        #inbox-overlay { position: absolute; inset: 0; background: var(--chat-bg); z-index: 1000; display: none; flex-direction: column; }
        #msg-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: #ffffff; border-bottom-left-radius: 2px; }
        .timestamp { font-size: 10px; color: #888; display: block; text-align: right; margin-top: 4px; }
        .tick { color: #34B7F1; font-weight: bold; margin-left: 4px; }

        .chat-footer { background: #f0f0f0; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .chat-footer input { margin-bottom: 0; border-radius: 30px; border: 1px solid #ccc; padding: 12px 20px; flex: 1; height: 45px; }
        .send-btn { width: 45px; height: 45px; background: var(--dark); color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        .hidden { display: none !important; }
        .typing-txt { font-size: 11px; color: #fff; font-style: italic; opacity: 0.9; }
    </style>
</head>
<body>

<div id="app-wrap">
    <div id="view-login" class="auth-overlay">
        <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="logo-large">
        <div class="auth-title">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        <input type="number" id="l-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
        <input type="password" id="l-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
        <button class="btn-main" onclick="processLogin()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="btn-secondary" onclick="switchView('reg')">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</button>
    </div>

    <div id="view-reg" class="auth-overlay hidden">
        <div class="auth-title">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®</div>
        <input type="text" id="r-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ">
        <input type="number" id="r-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
        <input type="password" id="r-pass" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®">
        <button class="btn-main" onclick="sendOTPRequest()">‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        <button class="btn-secondary" onclick="switchView('login')">‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá?</button>
    </div>

    <div id="view-otp" class="auth-overlay hidden">
        <div class="auth-title">‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</div>
        <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§</p>
        <input type="number" id="otp-code" placeholder="‡ß™ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®">
        <button class="btn-main" onclick="verifyOTP()">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="view-main" style="display:none; flex-direction:column; height:100%;">
        <header>
            <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="profile-btn" onclick="alert('Profile Features Coming!')">
            <div class="header-title">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á</div>
            <span onclick="addPerson()" style="cursor:pointer; font-size:24px;">‚ûï</span>
            <span onclick="userLogout()" style="cursor:pointer; font-size:20px;">üö™</span>
        </header>
        <div id="chat-list"></div>
    </div>

    <div id="inbox-overlay">
        <header>
            <span onclick="closeChat()" style="cursor:pointer; font-size:22px;">‚¨ÖÔ∏è</span>
            <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="profile-btn">
            <div style="flex:1">
                <div id="target-name" style="font-weight:bold;">‡¶®‡¶æ‡¶Æ</div>
                <div id="typing-box" class="typing-txt" style="display:none;">‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡¶õ‡ßá...</div>
            </div>
        </header>
        <div id="msg-container"></div>
        <div class="chat-footer">
            <input type="text" id="m-input" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="handleTyping()">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>

<script>
    // ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myPhone = localStorage.getItem("lb_session") ? atob(localStorage.getItem("lb_session")) : null;
    let currentChat = null;
    let tTimer;
    let otpTempData = null;

    function switchView(view) {
        document.getElementById('view-login').classList.toggle('hidden', view !== 'login');
        document.getElementById('view-reg').classList.toggle('hidden', view !== 'reg');
        document.getElementById('view-otp').classList.toggle('hidden', view !== 'otp');
    }

    // --- ‡¶Ö‡¶•‡ßá‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---
    function sendOTPRequest() {
        const name = document.getElementById('r-name').value;
        const ph = document.getElementById('r-phone').value;
        const ps = document.getElementById('r-pass').value;
        if(ph.length < 10 || !name || !ps) return alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡¶ø‡¶®");

        const code = Math.floor(1000 + Math.random() * 9000).toString();
        otpTempData = { name, ph, ps, code };
        
        db.ref('otp_requests/' + ph).set({ ph, code, name }).then(() => {
            switchView('otp');
            alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶° ‡¶π‡¶≤‡ßã: " + code + " (‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶è‡¶ü‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡¶æ‡¶¨‡ßá)");
        });
    }

    function verifyOTP() {
        const input = document.getElementById('otp-code').value;
        if(input === otpTempData.code) {
            db.ref('users/' + btoa(otpTempData.ph)).set({ name: otpTempData.name, ph: otpTempData.ph, pass: otpTempData.ps }).then(() => {
                loginSuccess(otpTempData.ph);
            });
        } else alert("‡¶≠‡ßÅ‡¶≤ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°!");
    }

    function processLogin() {
        const ph = document.getElementById('l-phone').value;
        const ps = document.getElementById('l-pass').value;
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists() && snap.val().pass === ps) loginSuccess(ph);
            else alert("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!");
        });
    }

    function loginSuccess(ph) {
        localStorage.setItem("lb_session", btoa(ph));
        location.reload();
    }

    // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡¶ú‡¶ø‡¶ï ---
    if(myPhone) {
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-main').style.display = 'flex';
        db.ref('status/' + btoa(myPhone)).set(true);
        db.ref('status/' + btoa(myPhone)).onDisconnect().set(false);
        fetchContacts();
    }

    function addPerson() {
        const ph = prompt("‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if(!ph || ph === myPhone) return;
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists()){
                const u = snap.val();
                db.ref('contacts/' + btoa(myPhone) + '/' + btoa(ph)).set({ name: u.name, ph: ph, last: Date.now() });
                openChat(ph, u.name);
            } else alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á‡¶§‡ßá ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶®‡ßü!");
        });
    }

    function fetchContacts() {
        db.ref('contacts/' + btoa(myPhone)).orderByChild('last').on('value', snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            let arr = []; snap.forEach(c => arr.unshift(c.val()));
            arr.forEach(u => {
                db.ref('status/' + btoa(u.ph)).on('value', st => {
                    const isOnline = st.val() === true;
                    list.innerHTML += `
                    <div class="user-card" onclick="openChat('${u.ph}', '${u.name}')">
                        <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" style="width:50px; height:50px; border-radius:50%">
                        <div class="user-info"><b>${u.name}</b><small>${u.ph}</small></div>
                        <div class="online-dot ${isOnline ? 'active' : ''}"></div>
                    </div>`;
                });
            });
        });
    }

    function openChat(ph, name) {
        currentChat = ph;
        document.getElementById('target-name').innerText = name;
        document.getElementById('inbox-overlay').style.display = 'flex';
        
        // ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
        db.ref('typing/' + btoa(ph) + '/' + btoa(myPhone)).on('value', s => {
            document.getElementById('typing-box').style.display = s.val() ? 'block' : 'none';
        });

        // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ (‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ)
        const id = [myPhone, ph].sort().join("_");
        db.ref('messages/' + id).on('value', snap => {
            const box = document.getElementById('msg-container');
            box.innerHTML = "";
            snap.forEach(mNode => {
                const m = mNode.val();
                const isMe = m.sender === myPhone;
                box.innerHTML += `
                <div class="bubble ${isMe ? 'sent' : 'received'}">
                    ${m.txt}
                    <span class="timestamp">${new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ${isMe ? '<span class="tick">‚úî‚úî</span>' : ''}</span>
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    function handleTyping() {
        db.ref('typing/' + btoa(myPhone) + '/' + btoa(currentChat)).set(true);
        clearTimeout(tTimer);
        tTimer = setTimeout(() => db.ref('typing/' + btoa(myPhone) + '/' + btoa(currentChat)).set(false), 2000);
    }

    function sendMessage() {
        const val = document.getElementById('m-input').value;
        if(!val || !currentChat) return;
        const id = [myPhone, currentChat].sort().join("_");
        db.ref('messages/' + id).push({ sender: myPhone, txt: val, time: Date.now() });
        db.ref('contacts/' + btoa(myPhone) + '/' + btoa(currentChat)).update({ last: Date.now() });
        document.getElementById('m-input').value = "";
    }

    function closeChat() { document.getElementById('inbox-overlay').style.display = 'none'; currentChat = null; }
    function userLogout() { db.ref('status/' + btoa(myPhone)).set(false); localStorage.clear(); location.reload(); }
</script>
</body>
</html>
