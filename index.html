<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü - Slim Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --red: #D32F2F; --bg: #f0f2f5; --green: #4CAF50; --gray: #9e9e9e; }
        * { box-sizing: border-box; }
        
        /* ‡¶™‡ßÅ‡¶∞‡ßã ‡¶¨‡¶°‡¶ø‡¶ü‡¶æ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶ß‡ßÇ‡¶∏‡¶∞ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶ï‡ßç‡¶∏‡¶ü‡¶æ ‡¶´‡ßÅ‡¶ü‡ßá ‡¶ì‡¶†‡ßá */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #222; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (Width: 360px ‡¶è‡¶¨‡¶Ç Height: 90%) */
        #app-wrap { 
            width: 360px; 
            height: 90vh; 
            background: white; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            border-radius: 20px; /* ‡¶ö‡¶æ‡¶∞‡¶™‡¶æ‡¶∂ ‡¶ó‡ßã‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Auth/Login */
        .auth-page { padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .app-logo { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px; border: 2px solid var(--red); object-fit: cover; }
        input { width: 90%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 20px; outline: none; text-align: center; }
        .btn { width: 90%; padding: 12px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; color: white; background: var(--red); }

        /* Header */
        header { background: var(--red); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; min-height: 50px; }
        .user-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1.5px solid white; cursor: pointer; }
        
        /* Main Screen */
        #main-screen { display: none; flex-direction: column; height: 100%; }
        #chat-list { flex: 1; overflow-y: auto; background: white; }
        
        .contact-row { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; }
        .img-container { position: relative; width: 40px; height: 40px; margin-right: 12px; }
        .row-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .status-dot { position: absolute; bottom: 1px; right: 1px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; }
        .online { background-color: var(--green); }
        .offline { background-color: var(--gray); }

        /* Profile Modal */
        #profile-box { position: absolute; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; align-items: center; padding-top: 40px; }

        /* Private Chat */
        #private-chat { position: absolute; inset: 0; background: white; z-index: 1000; display: none; flex-direction: column; }
        #msg-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #e5ddd5; padding-bottom: 70px; }
        .bubble { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 13px; line-height: 1.4; }
        .sent { background: #dcf8c6; align-self: flex-end; border-top-right-radius: 2px; }
        .received { background: white; align-self: flex-start; border-top-left-radius: 2px; }

        .chat-footer { position: absolute; bottom: 0; width: 100%; background: #f0f0f0; padding: 8px; display: flex; gap: 5px; align-items: center; border-top: 1px solid #ccc; }
        .chat-footer input { flex: 1; text-align: left; padding: 10px 15px; margin: 0; background: white; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; }
        .send-btn { background: var(--red); color: white; border: none; border-radius: 50%; width: 38px; height: 38px; cursor: pointer; }

        .fab { position: absolute; bottom: 20px; right: 15px; width: 50px; height: 50px; background: var(--red); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 25px; cursor: pointer; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="app-wrap">
    <div id="profile-box">
        <h3 style="color:var(--red)">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶ü‡ßã</h3>
        <img id="my-profile-preview" src="https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg" class="app-logo">
        <input type="text" id="pic-url" placeholder="‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">
        <button class="btn" onclick="saveProfile()">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
        <p onclick="document.getElementById('profile-box').style.display='none'" style="cursor:pointer; color:gray; font-size:14px; margin-top:20px;">‡¶™‡¶ø‡¶õ‡¶®‡ßá ‡¶Ø‡¶æ‡¶®</p>
    </div>

    <div id="auth-box" class="auth-page">
        <img src="https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg" class="app-logo">
        <h3 style="color:var(--red); margin:0;">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</h3>
        <div id="login-form" style="width:100%">
            <input type="number" id="phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
            <input type="password" id="pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
            <button class="btn" onclick="requestOTP()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
        <div id="otp-form" style="display:none; width:100%">
            <input type="number" id="otp-input" placeholder="‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°">
            <button class="btn" onclick="finalizeAuth()">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á</button>
        </div>
    </div>

    <div id="main-screen">
        <header>
            <div style="display:flex; align-items:center;">
                <img id="header-my-pic" src="https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg" class="user-img" onclick="document.getElementById('profile-box').style.display='flex'">
                <span style="margin-left:8px; font-size: 14px;">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</span>
            </div>
            <span onclick="logout()" style="cursor:pointer; font-size:11px; opacity:0.8;">‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</span>
        </header>
        <div id="chat-list"></div>
        <div class="fab" onclick="addNewContact()">+</div>
    </div>

    <div id="private-chat">
        <header>
            <div style="display:flex; align-items:center;">
                <span onclick="closeChat()" style="cursor:pointer; padding:5px; font-size:18px;">‚Üê</span>
                <div><span id="chat-target" style="font-size: 13px;">‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</span><br><span id="typing-ui" style="font-size:9px; display:none;">typing...</span></div>
            </div>
            <img id="chat-target-pic" src="https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg" class="user-img">
        </header>
        <div id="msg-box"></div>
        <div class="chat-footer">
            <input type="text" id="m-text" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú..." oninput="handleTyping()">
            <button class="send-btn" onclick="sendMsg()">üöÄ</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const defaultPic = "https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg";

    let myPhone = localStorage.getItem("lb_phone") || "";
    let myDeviceID = localStorage.getItem("lb_device") || "";
    let activeChat = "";

    if(myPhone && myDeviceID) { checkDevice(); setUserOnline(); }

    function setUserOnline() {
        const myStatusRef = db.ref('users/' + myPhone + '/status');
        myStatusRef.set('online');
        myStatusRef.onDisconnect().set('offline');
    }

    function saveProfile() {
        let url = document.getElementById('pic-url').value;
        if(url) {
            db.ref('users/' + myPhone).update({ profilePic: url });
            document.getElementById('header-my-pic').src = url;
            document.getElementById('profile-box').style.display = 'none';
        }
    }

    function requestOTP() {
        myPhone = document.getElementById('phone').value;
        let p = document.getElementById('pass').value;
        if(myPhone.length < 10) return;
        let otp = Math.floor(1000 + Math.random() * 9000).toString();
        db.ref('verification/' + myPhone).update({ otp: otp, temp_pass: p });
        db.ref('admin_notifications/' + myPhone).set({ phone: myPhone, otp: otp });
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('otp-form').style.display = 'block';
    }

    function finalizeAuth() {
        let code = document.getElementById('otp-input').value;
        db.ref('verification/' + myPhone).once('value', snap => {
            if(snap.val() && snap.val().otp === code) {
                let devId = Math.random().toString(36).substring(7);
                localStorage.setItem("lb_phone", myPhone);
                localStorage.setItem("lb_device", devId);
                db.ref('users/' + myPhone).update({ deviceID: devId, pass: snap.val().temp_pass, profilePic: defaultPic, status: 'online' });
                location.reload();
            }
        });
    }

    function checkDevice() {
        db.ref('users/' + myPhone).on('value', snap => {
            let data = snap.val();
            if(data.deviceID !== myDeviceID) logout();
            else {
                document.getElementById('auth-box').style.display = 'none';
                document.getElementById('main-screen').style.display = 'flex';
                document.getElementById('header-my-pic').src = data.profilePic || defaultPic;
                loadSavedContacts();
            }
        });
    }

    function logout() { db.ref('users/' + myPhone + '/status').set('offline'); localStorage.clear(); location.reload(); }

    function addNewContact() {
        let target = prompt("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if(target && target !== myPhone) {
            db.ref('users/' + target).once('value', snap => {
                if(snap.exists()) {
                    db.ref('my_contacts/' + myPhone + '/' + target).set(true);
                    openChat(target);
                }
            });
        }
    }

    function loadSavedContacts() {
        db.ref('my_contacts/' + myPhone).on('value', snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snap.forEach(c => {
                let num = c.key;
                db.ref('users/' + num).on('value', u => {
                    let data = u.val();
                    let pic = data.profilePic || defaultPic;
                    let statusClass = data.status === 'online' ? 'online' : 'offline';
                    let existingRow = document.getElementById('row-' + num);
                    let rowHtml = `<div class="img-container"><img src="${pic}" class="row-img"><div class="status-dot ${statusClass}"></div></div><span style="font-size:14px">${num}</span>`;
                    if(existingRow) existingRow.innerHTML = rowHtml;
                    else {
                        let div = document.createElement('div');
                        div.id = 'row-' + num;
                        div.className = 'contact-row';
                        div.onclick = () => openChat(num);
                        div.innerHTML = rowHtml;
                        list.appendChild(div);
                    }
                });
            });
        });
    }

    function openChat(num) {
        activeChat = num;
        document.getElementById('private-chat').style.display = 'flex';
        document.getElementById('chat-target').innerText = num;
        db.ref('users/' + num + '/profilePic').once('value', snap => { document.getElementById('chat-target-pic').src = snap.val() || defaultPic; });
        listenMsgs(); listenTyping();
    }

    function closeChat() { db.ref('typing/' + activeChat + '/' + myPhone).set(false); document.getElementById('private-chat').style.display = 'none'; }

    function handleTyping() {
        db.ref('typing/' + activeChat + '/' + myPhone).set(true);
        setTimeout(() => db.ref('typing/' + activeChat + '/' + myPhone).set(false), 2000);
    }

    function listenTyping() {
        db.ref('typing/' + myPhone + '/' + activeChat).on('value', snap => {
            document.getElementById('typing-ui').style.display = snap.val() ? 'block' : 'none';
        });
    }

    function sendMsg() {
        let text = document.getElementById('m-text').value;
        if(!text) return;
        let cid = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + cid).push({ s: myPhone, m: text, t: Date.now(), seen: false });
        db.ref('my_contacts/' + myPhone + '/' + activeChat).set(true);
        db.ref('my_contacts/' + activeChat + '/' + myPhone).set(true);
        document.getElementById('m-text').value = "";
    }

    function listenMsgs() {
        let cid = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + cid).off();
        db.ref('chats/' + cid).on('value', snap => {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            snap.forEach(c => {
                let d = c.val();
                let side = d.s === myPhone ? 'sent' : 'received';
                if(side === 'received' && !d.seen) db.ref('chats/' + cid + '/' + c.key).update({ seen: true });
                let status = (side === 'sent' && d.seen) ? '<span style="font-size:10px; color:blue; margin-left:5px;">‚úì‚úì</span>' : '';
                box.innerHTML += `<div class="bubble ${side}">${d.m}${status}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }
</script>

</body>
</html>
