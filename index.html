<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lal Bilai - Premium Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --red: #D32F2F; --white: #fff; --gray: #f0f2f5; --text: #1c1e21; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        #app-wrap { width: 100%; max-width: 450px; height: 100vh; background: var(--white); position: relative; display: flex; flex-direction: column; }

        /* Custom UI Alerts */
        #custom-alert { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .alert-box { background: #fff; padding: 25px; border-radius: 20px; width: 100%; text-align: center; border-bottom: 5px solid var(--red); }

        /* Headers */
        header { background: var(--red); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; position: sticky; top: 0; z-index: 1000; }
        
        /* Screens */
        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: #fff; z-index: 100; flex-direction: column; padding-bottom: 70px; }
        .visible { display: flex; }

        /* Chat History List */
        .chat-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .chat-item:active { background: #f9f9f9; }
        .user-img { width: 50px; height: 50px; border-radius: 50%; background: #ddd; margin-right: 15px; }

        /* Chat Window */
        #chat-win { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; }
        .sent { align-self: flex-end; background: #dcf8c6; color: #000; border-top-right-radius: 0; }
        .rec { align-self: flex-start; background: #fff; color: #000; border-top-left-radius: 0; }
        
        /* Inputs */
        .input-area { padding: 10px; background: #f0f0f0; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--red); color: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Bottom Nav */
        nav { position: absolute; bottom: 0; width: 100%; height: 65px; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .nav-tab { display: flex; flex-direction: column; align-items: center; color: #888; cursor: pointer; font-size: 12px; }
        .nav-tab.active { color: var(--red); font-weight: bold; }

        /* Powered By */
        .powered { font-size: 10px; color: #bbb; position: absolute; bottom: 70px; width: 100%; text-align: center; z-index: 5; pointer-events: none; }
    </style>
</head>
<body>

<div id="app-wrap">
    <div class="powered">Powered by KAIYUM</div>

    <div id="custom-alert">
        <div class="alert-box">
            <p id="alert-msg"></p>
            <button class="circle-btn" style="width: auto; padding: 0 20px; border-radius: 10px;" onclick="closeAlert()">Ok</button>
        </div>
    </div>

    <div id="scr-home" class="screen visible">
        <header><span>Lal Bilai</span> <span onclick="switchScreen('scr-add')">‚ûï</span></header>
        <div id="history-list" style="flex:1; overflow-y:auto;">
            <p style="text-align:center; color:#999; margin-top:20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶®‡ßá‡¶á‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®!</p>
        </div>
    </div>

    <div id="scr-chat" class="screen">
        <header><span onclick="switchScreen('scr-home')">‚¨ÖÔ∏è</span> <span id="chat-user-name">Chat</span> <span></span></header>
        <div id="chat-win"></div>
        <div class="input-area">
            <button class="circle-btn" style="background:#555;" onclick="sendVoice()">üé§</button>
            <input type="text" id="msg-input" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
            <button class="circle-btn" onclick="sendMsg()">‚ñ∂Ô∏è</button>
        </div>
    </div>

    <div id="scr-settings" class="screen">
        <header><span>Settings</span></header>
        <div style="padding: 20px; text-align: center;">
            <div class="user-img" style="width: 80px; height: 80px; margin: 0 auto 15px auto;"></div>
            <input type="text" id="set-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ" style="margin-bottom:10px;">
            <input type="text" id="set-username" placeholder="@‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®" style="margin-bottom:10px;">
            <input type="number" id="set-age" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßü‡¶∏" style="margin-bottom:10px;">
            <button class="circle-btn" style="width:100%; border-radius:10px;" onclick="saveProfile()">Save Profile</button>
            <button class="circle-btn" style="width:100%; border-radius:10px; background:#333; margin-top:10px;" onclick="logout()">Logout</button>
        </div>
    </div>

    <div id="scr-add" class="screen">
        <header><span onclick="switchScreen('scr-home')">‚¨ÖÔ∏è</span> <span>Add Friend</span></header>
        <div style="padding: 20px;">
            <input type="number" id="target-phone" placeholder="‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
            <button class="circle-btn" style="width:100%; border-radius:10px; margin-top:15px;" onclick="startNewChat()">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <nav>
        <div class="nav-tab active" onclick="switchScreen('scr-home', this)"><span>üè†</span><span>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</span></div>
        <div class="nav-tab" onclick="switchScreen('scr-settings', this)"><span>‚öôÔ∏è</span><span>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span></div>
    </nav>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myPhone = localStorage.getItem("lb_phone") ? atob(localStorage.getItem("lb_phone")) : null;
    let activeChat = null;

    function showAlert(m) { document.getElementById('alert-msg').innerText = m; document.getElementById('custom-alert').style.display='flex'; }
    function closeAlert() { document.getElementById('custom-alert').style.display='none'; }

    function switchScreen(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible'));
        document.getElementById(id).classList.add('visible');
        if(el) {
            document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        if(id === 'scr-home') loadHistory();
    }

    // --- Profile & History ---
    function saveProfile() {
        const n = document.getElementById('set-name').value;
        const u = document.getElementById('set-username').value;
        const a = document.getElementById('set-age').value;
        if(!n || !u) return showAlert("‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¶‡¶ø‡¶®!");
        db.ref('users/' + btoa(myPhone)).update({ name: n, username: u, age: a })
          .then(() => showAlert("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
    }

    function loadHistory() {
        if(!myPhone) return;
        db.ref('my_contacts/' + btoa(myPhone)).on('value', snap => {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            if(!snap.exists()) list.innerHTML = `<p style="text-align:center; color:#999; margin-top:20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶®‡ßá‡¶á!</p>`;
            snap.forEach(child => {
                const user = child.val();
                list.innerHTML += `
                    <div class="chat-item" onclick="openChat('${user.phone}', '${user.name}')">
                        <div class="user-img"></div>
                        <div>
                            <div style="font-weight:bold;">${user.name}</div>
                            <div style="font-size:12px; color:#888;">${user.phone}</div>
                        </div>
                    </div>`;
            });
        });
    }

    // --- Chat Logic ---
    function startNewChat() {
        const ph = document.getElementById('target-phone').value;
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists()) {
                const u = snap.val();
                db.ref('my_contacts/' + btoa(myPhone) + '/' + btoa(ph)).set({ name: u.name, phone: ph });
                openChat(ph, u.name);
            } else showAlert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á!");
        });
    }

    function openChat(ph, name) {
        activeChat = ph;
        document.getElementById('chat-user-name').innerText = name;
        switchScreen('scr-chat');
        const chatId = [myPhone, ph].sort().join("_");
        db.ref('chats/' + chatId).on('value', snap => {
            const win = document.getElementById('chat-win');
            win.innerHTML = "";
            snap.forEach(msg => {
                const m = msg.val();
                win.innerHTML += `<div class="msg ${m.sender === myPhone ? 'sent' : 'rec'}">${m.text}</div>`;
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function sendMsg() {
        const t = document.getElementById('msg-input').value;
        if(!t || !activeChat) return;
        const chatId = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + chatId).push({ sender: myPhone, text: t, time: Date.now() });
        document.getElementById('msg-input').value = "";
    }

    function sendVoice() {
        showAlert("‡¶≠‡ßü‡ßá‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá! ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
    }

    window.onload = () => { if(myPhone) loadHistory(); else showAlert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶ó‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!"); };
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
