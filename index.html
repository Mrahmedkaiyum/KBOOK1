<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lal Bilai Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --main: #25D366; --dark: #075E54; --bg: #ffffff; --light-bg: #f0f2f5; --red: #D32F2F; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        #app-wrap { width: 100%; max-width: 450px; height: 100vh; background: var(--bg); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* Custom Alert */
        #custom-alert { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .alert-box { background: #fff; padding: 20px; border-radius: 15px; width: 100%; text-align: center; border-top: 5px solid var(--main); }

        /* Screens */
        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: #fff; z-index: 100; flex-direction: column; }
        .visible { display: flex; }
        .header { background: var(--dark); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }

        /* Form Styling */
        .form-container { padding: 30px; display: flex; flex-direction: column; gap: 15px; justify-content: center; height: 100%; }
        input { padding: 14px; border-radius: 10px; border: 1px solid #ddd; outline: none; font-size: 15px; background: var(--light-bg); transition: 0.3s; }
        input:focus { border-color: var(--main); background: #fff; }
        .btn { padding: 15px; border-radius: 10px; border: none; background: var(--main); color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn:active { transform: scale(0.98); }

        /* Chat Styles */
        #chat-win { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 5px; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 10px; font-size: 14px; position: relative; line-height: 1.4; }
        .sent { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; }
        .rec { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
        .tick { font-size: 10px; margin-left: 5px; color: #999; }
        .seen { color: #34B7F1 !important; }

        /* Bottom Nav */
        nav { height: 65px; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 500; }
        .nav-item { cursor: pointer; text-align: center; color: #888; transition: 0.3s; }
        .nav-active { color: var(--main); font-weight: bold; }

        /* Splash */
        #splash { background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cat-logo { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--main); }
        .powered { font-size: 12px; color: #888; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="app-wrap">
    <div id="custom-alert">
        <div class="alert-box">
            <p id="alert-msg" style="margin-bottom: 20px; color: #333;"></p>
            <button class="btn" style="width: 100px;" onclick="closeAlert()">Ok</button>
        </div>
    </div>

    <div id="splash" class="screen visible">
        <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="cat-logo">
        <div class="powered">Powered by KAIYUM</div>
    </div>

    <div id="scr-auth" class="screen">
        <div class="form-container">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:20px;">
                <span onclick="setLang('en')" style="cursor:pointer; font-weight:bold;">EN</span> | 
                <span onclick="setLang('bn')" style="cursor:pointer; font-weight:bold;">‡¶¨‡¶æ‡¶Ç</span>
            </div>
            <h2 id="auth-title">Login</h2>
            <input type="number" id="auth-ph" placeholder="Mobile (Max 11 digit)" oninput="if(this.value.length > 11) this.value = this.value.slice(0,11);">
            <input type="password" id="auth-ps" placeholder="Password">
            <button class="btn" onclick="handleAuth()" id="btn-auth">Sign In</button>
            <p id="auth-switch" onclick="toggleAuthMode()" style="text-align:center; cursor:pointer; font-size:14px; color:var(--dark);">Need an account? Register</p>
            <p onclick="forgotPass()" style="text-align:center; font-size:12px; color:var(--red); cursor:pointer;">Forgot Password?</p>
        </div>
    </div>

    <div id="scr-otp" class="screen">
        <div class="form-container">
            <h3>Verify OTP</h3>
            <p style="font-size:12px; color:#666;">Check your admin for code</p>
            <input type="number" id="otp-val" placeholder="4 Digit Code" style="text-align:center; font-size:24px; letter-spacing:10px;">
            <button class="btn" onclick="verifyOTP()">Confirm</button>
        </div>
    </div>

    <div id="scr-main" class="screen">
        <div class="header">
            <span id="main-title">Lal Bilai</span>
            <span onclick="openSearch()">‚ûï</span>
        </div>
        <div id="contact-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <nav>
            <div class="nav-item nav-active" onclick="switchMainTab('chats')">üí¨ <br><small>Chats</small></div>
            <div class="nav-item" onclick="switchMainTab('settings')">‚öôÔ∏è <br><small>Settings</small></div>
        </nav>
    </div>

    <div id="scr-chat" class="screen">
        <div class="header">
            <span onclick="closeChat()">‚¨ÖÔ∏è</span>
            <div style="flex:1; margin-left:10px;">
                <div id="chat-user-name">...</div>
                <div id="chat-status" style="font-size:10px; font-weight:normal;">offline</div>
            </div>
        </div>
        <div id="chat-win"></div>
        <div style="padding:10px; background:#f0f0f0; display:flex; gap:10px; align-items:center;">
            <input type="text" id="msg-input" placeholder="Type..." style="margin-bottom:0; border-radius:20px;">
            <button class="btn" style="width:60px; padding:10px; border-radius:50%;" onclick="sendMsg()">üê±</button>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let lang = 'en';
    let isLoginMode = true;
    let myPhone = localStorage.getItem("lb_phone") ? atob(localStorage.getItem("lb_phone")) : null;
    let activeChat = null;
    let tempUser = null;

    const t = {
        en: { login: "Login", reg: "Register", need: "Need account? Register", have: "Have account? Login", ph: "Mobile Number", ps: "Password", welcome: "Welcome back to Lal Bilai!" },
        bn: { login: "‡¶≤‡¶ó‡¶á‡¶®", reg: "‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®", need: "‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®", have: "‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? ‡¶≤‡¶ó‡¶á‡¶®", ph: "‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞", ps: "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°", welcome: "‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!" }
    };

    // --- UI Controls ---
    function showAlert(msg) { document.getElementById('alert-msg').innerText = msg; document.getElementById('custom-alert').style.display = 'flex'; }
    function closeAlert() { document.getElementById('custom-alert').style.display = 'none'; }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible')); document.getElementById(id).classList.add('visible'); }

    window.onload = () => {
        setTimeout(() => {
            if(myPhone) { setupApp(); }
            else { showScreen('scr-auth'); setLang('en'); }
        }, 2500);
    };

    function setLang(l) {
        lang = l;
        document.getElementById('auth-title').innerText = isLoginMode ? t[lang].login : t[lang].reg;
        document.getElementById('auth-ph').placeholder = t[lang].ph;
        document.getElementById('auth-ps').placeholder = t[lang].ps;
        document.getElementById('btn-auth').innerText = isLoginMode ? t[lang].login : t[lang].reg;
        document.getElementById('auth-switch').innerText = isLoginMode ? t[lang].need : t[lang].have;
    }

    function toggleAuthMode() { isLoginMode = !isLoginMode; setLang(lang); }

    // --- Auth Logic ---
    function handleAuth() {
        const ph = document.getElementById('auth-ph').value;
        const ps = document.getElementById('auth-ps').value;
        if(ph.length < 10) return showAlert("Invalid Phone Number");

        if(isLoginMode) {
            db.ref('users/' + btoa(ph)).once('value', snap => {
                if(snap.exists() && snap.val().pass === ps) {
                    localStorage.setItem("lb_phone", btoa(ph));
                    location.reload();
                } else showAlert("Wrong credentials!");
            });
        } else {
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            tempUser = { ph, ps, code };
            db.ref('otp_requests/' + ph).set({ ph, code, time: Date.now() }).then(() => {
                showScreen('scr-otp');
                window.open(`https://wa.me/9660558687975?text=Hi, Give me OTP for ${ph}`);
            });
        }
    }

    function verifyOTP() {
        const input = document.getElementById('otp-val').value;
        if(input === tempUser.code) {
            db.ref('users/' + btoa(tempUser.ph)).set({ phone: tempUser.ph, pass: tempUser.ps, name: "User_"+tempUser.ph.slice(-4), joined: Date.now() }).then(() => {
                showAlert(t[lang].welcome);
                localStorage.setItem("lb_phone", btoa(tempUser.ph));
                location.reload();
            });
        } else showAlert("Wrong OTP");
    }

    function forgotPass() {
        const ph = document.getElementById('auth-ph').value;
        if(!ph) return showAlert("Enter number first");
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists()) {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                tempUser = { ph, mode: 'reset', code };
                db.ref('otp_requests/' + ph).set({ ph, code, time: Date.now() }).then(() => {
                    showScreen('scr-otp');
                });
            } else showAlert("Number not registered!");
        });
    }

    // --- Chat Logic ---
    function setupApp() {
        showScreen('scr-main');
        updateStatus(true);
        loadChatList();
    }

    function openSearch() {
        const target = prompt("Enter Friend's Mobile:");
        if(!target) return;
        db.ref('users/' + btoa(target)).once('value', snap => {
            if(snap.exists()) {
                const u = snap.val();
                if(confirm(`Add ${u.name}?`)) {
                    startChat(target, u.name);
                }
            } else showAlert("User not found!");
        });
    }

    function startChat(ph, name) {
        activeChat = ph;
        document.getElementById('chat-user-name').innerText = name;
        showScreen('scr-chat');
        const chatId = [myPhone, ph].sort().join("_");
        
        // Listen Status
        db.ref('status/' + ph).on('value', s => {
            document.getElementById('chat-status').innerText = s.val() ? 'online' : 'offline';
            document.getElementById('chat-status').style.color = s.val() ? '#25D366' : '#999';
        });

        // Listen Messages
        db.ref('chats/' + chatId).on('value', snap => {
            const win = document.getElementById('chat-win');
            win.innerHTML = "";
            snap.forEach(mNode => {
                const m = mNode.val();
                const isMe = m.sender === myPhone;
                if(!isMe && !m.seen) db.ref('chats/'+chatId+'/'+mNode.key).update({seen: true});
                
                win.innerHTML += `
                    <div class="msg ${isMe ? 'sent' : 'rec'}">
                        ${m.text}
                        ${isMe ? `<span class="tick ${m.seen ? 'seen' : ''}">‚úî‚úî</span>` : ''}
                    </div>`;
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function sendMsg() {
        const txt = document.getElementById('msg-input').value;
        if(!txt || !activeChat) return;
        const chatId = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + chatId).push({ sender: myPhone, text: txt, time: Date.now(), seen: false });
        document.getElementById('msg-input').value = "";
    }

    function closeChat() { showScreen('scr-main'); activeChat = null; }
    function updateStatus(s) { if(myPhone) { db.ref('status/' + myPhone).set(s); db.ref('status/' + myPhone).onDisconnect().set(false); }}
</script>
</body>
</html>
