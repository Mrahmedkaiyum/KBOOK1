<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lal Bilai - Ultimate X Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* -----------------------------------------------------------
         1. CSS VARIABLES & THEME CONFIGURATION
         -----------------------------------------------------------
        */
        :root {
            --primary-glow: #00ff88;
            --primary-dark: #008069;
            --whatsapp-green: #25d366;
            --bg-deep: #0b141a;
            --bg-panel: #111b21;
            --bg-hover: #202c33;
            --text-main: #e9edef;
            --text-dim: #8696a0;
            --bubble-sent: #005c4b;
            --bubble-received: #202c33;
            --accent-blue: #53bdeb;
            --error-red: #ff5252;
            --shadow-custom: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* -----------------------------------------------------------
         2. CORE RESET & BODY STYLES
         -----------------------------------------------------------
        */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background: #000;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-main);
        }

        /* -----------------------------------------------------------
         3. MAIN APPLICATION WRAPPER
         -----------------------------------------------------------
        */
        #app-shell {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: var(--bg-deep);
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 100px rgba(0, 255, 136, 0.2);
            border-left: 1px solid #222;
            border-right: 1px solid #222;
        }

        /* -----------------------------------------------------------
         4. AUTHENTICATION SCREENS (LOGIN / REGISTER / OTP)
         -----------------------------------------------------------
        */
        .auth-container {
            position: absolute;
            inset: 0;
            background: var(--bg-panel);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 40px;
            transition: all 0.5s ease;
        }

        .auth-logo-box {
            position: relative;
            margin-bottom: 40px;
        }

        .auth-logo-box img {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            border: 4px solid var(--primary-glow);
            padding: 5px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
        }

        .auth-card {
            width: 100%;
            background: #1d2a33;
            padding: 30px;
            border-radius: 25px;
            box-shadow: var(--shadow-custom);
            border: 1px solid #2a3942;
        }

        .auth-card h2 {
            margin-bottom: 25px;
            font-size: 26px;
            color: var(--primary-glow);
        }

        .input-group {
            width: 100%;
            margin-bottom: 20px;
            position: relative;
        }

        .input-group input {
            width: 100%;
            padding: 16px 20px;
            background: #2a3942;
            border: 1px solid transparent;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: 0.3s;
        }

        .input-group input:focus {
            border-color: var(--primary-glow);
            background: #32444f;
        }

        .btn-glow {
            width: 100%;
            padding: 16px;
            background: var(--primary-glow);
            color: #000;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
            transition: 0.3s;
        }

        .btn-glow:active {
            transform: scale(0.97);
        }

        /* -----------------------------------------------------------
         5. MAIN MESSENGER DASHBOARD
         -----------------------------------------------------------
        */
        header {
            background: #202c33;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 75px;
            border-bottom: 1px solid #2a3942;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-brand {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-glow), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 20px;
            font-size: 22px;
            color: var(--text-dim);
        }

        .header-actions span {
            cursor: pointer;
            transition: 0.2s;
        }

        .header-actions span:hover {
            color: var(--primary-glow);
        }

        /* -----------------------------------------------------------
         6. CONTACT LIST AREA
         -----------------------------------------------------------
        */
        #contact-container {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-deep);
        }

        .contact-tile {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #222d34;
            cursor: pointer;
            transition: background 0.3s;
        }

        .contact-tile:hover {
            background: var(--bg-hover);
        }

        .tile-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            position: relative;
        }

        .tile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .online-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #555;
            border: 2px solid var(--bg-deep);
            border-radius: 50%;
        }

        .online-badge.active {
            background: var(--primary-glow);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .tile-content {
            flex: 1;
            margin-left: 15px;
        }

        .tile-content h4 {
            font-size: 17px;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .tile-content p {
            font-size: 14px;
            color: var(--text-dim);
        }

        /* -----------------------------------------------------------
         7. REAL-TIME INBOX (THE CORE ENGINE)
         -----------------------------------------------------------
        */
        #inbox-panel {
            position: absolute;
            inset: 0;
            background: var(--bg-chat);
            z-index: 5000;
            display: none;
            flex-direction: column;
            background-color: #0b141a;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: multiply;
        }

        #chat-scroller {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-row {
            display: flex;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }

        .message-row.me { justify-content: flex-end; }
        .message-row.them { justify-content: flex-start; }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .me .message-bubble {
            background: var(--bubble-sent);
            color: white;
            border-top-right-radius: 2px;
        }

        .them .message-bubble {
            background: var(--bubble-received);
            color: white;
            border-top-left-radius: 2px;
        }

        .msg-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.7;
        }

        /* -----------------------------------------------------------
         8. INPUT ENGINE STYLES
         -----------------------------------------------------------
        */
        .input-dock {
            background: #202c33;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .text-input-field {
            flex: 1;
            background: #2a3942;
            border-radius: 25px;
            padding: 14px 22px;
            color: white;
            border: none;
            outline: none;
            font-size: 16px;
        }

        .send-circular-btn {
            width: 52px;
            height: 52px;
            background: var(--primary-glow);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: 0.3s;
        }

        .send-circular-btn:hover {
            transform: rotate(-10deg) scale(1.1);
        }

        /* -----------------------------------------------------------
         9. UTILITY CLASSES & KEYFRAMES
         -----------------------------------------------------------
        */
        .hidden { display: none !important; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* -----------------------------------------------------------
         10. SCROLLBAR CUSTOMIZATION
         -----------------------------------------------------------
        */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

    </style>
</head>
<body>

<div id="app-shell">
    
    <div id="auth-view" class="auth-container">
        <div class="auth-logo-box">
            <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" alt="Lal Bilai">
        </div>

        <div class="auth-card">
            <h2 id="ui-auth-title">‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</h2>
            
            <div id="reg-form-part" class="hidden">
                <div class="input-group">
                    <input type="text" id="in-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
                </div>
            </div>

            <div class="input-group">
                <input type="number" id="in-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
            </div>

            <div class="input-group">
                <input type="password" id="in-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
            </div>

            <div id="otp-form-part" class="hidden">
                <div class="input-group">
                    <input type="number" id="in-otp" placeholder="‡ß™ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°">
                </div>
            </div>

            <button class="btn-glow" id="btn-master-auth" onclick="mainAuthHandler()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            
            <p id="ui-auth-toggle" style="margin-top: 20px; cursor: pointer; color: var(--primary-glow); font-size: 14px;" onclick="toggleAuthView()">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</p>
        </div>
    </div>

    <div id="main-interface" class="hidden" style="flex:1; display:flex; flex-direction:column;">
        <header>
            <div class="header-left">
                <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--primary-glow);">
                <div class="app-brand">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á X</div>
            </div>
            <div class="header-actions">
                <span onclick="triggerAddFriend()">‚ûï</span>
                <span onclick="triggerLogout()">üö™</span>
            </div>
        </header>

        <div style="padding: 10px 15px; background: var(--bg-deep);">
            <div style="background: #202c33; padding: 10px 15px; border-radius: 10px; display: flex; align-items: center;">
                <input type="text" placeholder="‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." style="background:transparent; border:none; color:white; width:100%; outline:none; font-size:14px;">
            </div>
        </div>

        <div id="contact-container">
            </div>
    </div>

    <div id="inbox-panel">
        <header>
            <div class="header-left">
                <span onclick="exitInbox()" style="cursor:pointer; font-size:26px; color:var(--primary-glow); margin-right:10px;">‚¨Ö</span>
                <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" style="width:40px; height:40px; border-radius:50%;">
                <div>
                    <div id="ui-target-name" style="font-weight:bold; font-size:17px; color:white;">‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á</div>
                    <div id="ui-typing-indicator" style="font-size:11px; color:var(--primary-glow); display:none;">‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡¶õ‡ßá...</div>
                </div>
            </div>
        </header>

        <div id="chat-scroller">
            </div>

        <div class="input-dock">
            <input type="text" id="field-msg" class="text-input-field" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="pushTypingSignal()">
            <button class="send-circular-btn" onclick="executeSendMessage()">‚û§</button>
        </div>
    </div>

</div>

<script>
    /* -----------------------------------------------------------
     11. FIREBASE CORE SYSTEM INITIALIZATION
     -----------------------------------------------------------
    */
    const firebase_app_config = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebase_app_config);
    const kernel_db = firebase.database();

    /* -----------------------------------------------------------
     12. GLOBAL APPLICATION STATE
     -----------------------------------------------------------
    */
    let SYSTEM_USER_ID = localStorage.getItem("lb_token") ? atob(localStorage.getItem("lb_token")) : null;
    let ACTIVE_CHAT_PARTNER = null;
    let IS_REGISTRATION_MODE = false;
    let SESSION_OTP_CODE = null;
    let TYPING_DEBOUNCE_TIMER;

    /* -----------------------------------------------------------
     13. AUTHENTICATION LOGIC UNIT
     -----------------------------------------------------------
    */
    function toggleAuthView() {
        IS_REGISTRATION_MODE = !IS_REGISTRATION_MODE;
        document.getElementById('ui-auth-title').innerText = IS_REGISTRATION_MODE ? "‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®" : "‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ";
        document.getElementById('reg-form-part').classList.toggle('hidden', !IS_REGISTRATION_MODE);
        document.getElementById('btn-master-auth').innerText = IS_REGISTRATION_MODE ? "‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®" : "‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('ui-auth-toggle').innerText = IS_REGISTRATION_MODE ? "‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? ‡¶≤‡¶ó‡¶á‡¶®" : "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®";
    }

    async function mainAuthHandler() {
        const ph = document.getElementById('in-phone').value;
        const ps = document.getElementById('in-pass').value;

        if (ph.length < 10) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®");

        if (!IS_REGISTRATION_MODE) {
            // LOGIN FLOW
            kernel_db.ref('users/' + btoa(ph)).once('value', snapshot => {
                if (snapshot.exists() && snapshot.val().ps === ps) {
                    finalizeSession(ph);
                } else {
                    alert("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶≠‡ßÅ‡¶≤!");
                }
            });
        } else {
            // REGISTRATION FLOW
            if (!SESSION_OTP_CODE) {
                SESSION_OTP_CODE = Math.floor(1000 + Math.random() * 9000).toString();
                document.getElementById('otp-form-part').classList.remove('hidden');
                document.getElementById('btn-master-auth').innerText = "‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®";
                alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°: " + SESSION_OTP_CODE);
            } else {
                const user_otp = document.getElementById('in-otp').value;
                if (user_otp === SESSION_OTP_CODE) {
                    const name = document.getElementById('in-name').value || "‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞";
                    kernel_db.ref('users/' + btoa(ph)).set({ name, ph, ps, ts: Date.now() }).then(() => {
                        finalizeSession(ph);
                    });
                } else {
                    alert("‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü!");
                }
            }
        }
    }

    function finalizeSession(ph) {
        localStorage.setItem("lb_token", btoa(ph));
        location.reload();
    }

    /* -----------------------------------------------------------
     14. CORE ENGINE INITIALIZATION
     -----------------------------------------------------------
    */
    if (SYSTEM_USER_ID) {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('main-interface').classList.remove('hidden');
        
        // PRESENCE SYSTEM
        kernel_db.ref('online_heartbeat/' + btoa(SYSTEM_USER_ID)).set(true);
        kernel_db.ref('online_heartbeat/' + btoa(SYSTEM_USER_ID)).onDisconnect().set(false);
        
        initContactListEngine();
    }

    /* -----------------------------------------------------------
     15. CONTACT & SEARCH ENGINE
     -----------------------------------------------------------
    */
    function triggerAddFriend() {
        const target = prompt("‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
        if (!target || target === SYSTEM_USER_ID) return;

        kernel_db.ref('users/' + btoa(target)).once('value', snap => {
            if (snap.exists()) {
                const data = snap.val();
                // CREATE BIDIRECTIONAL CONTACTS
                kernel_db.ref('contacts/' + btoa(SYSTEM_USER_ID) + '/' + btoa(target)).set({ name: data.name, ph: target, sync: Date.now() });
                kernel_db.ref('contacts/' + btoa(target) + '/' + btoa(SYSTEM_USER_ID)).set({ name: "‡¶¨‡¶®‡ßç‡¶ß‡ßÅ", ph: SYSTEM_USER_ID, sync: Date.now() });
                openInboxEngine(target, data.name);
            } else {
                alert("‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ü‡¶ø ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶®‡ßü!");
            }
        });
    }

    function initContactListEngine() {
        kernel_db.ref('contacts/' + btoa(SYSTEM_USER_ID)).orderByChild('sync').on('value', snap => {
            const list_div = document.getElementById('contact-container');
            list_div.innerHTML = "";
            let chat_nodes = [];
            snap.forEach(c => chat_nodes.unshift(c.val()));

            chat_nodes.forEach(user => {
                // REAL-TIME ONLINE LISTENER
                kernel_db.ref('online_heartbeat/' + btoa(user.ph)).on('value', status_snap => {
                    const is_online = status_snap.val() === true;
                    const tile_id = "tile-" + btoa(user.ph);
                    if (document.getElementById(tile_id)) document.getElementById(tile_id).remove();

                    const tile = document.createElement('div');
                    tile.id = tile_id;
                    tile.className = 'contact-tile';
                    tile.onclick = () => openInboxEngine(user.ph, user.name);
                    tile.innerHTML = `
                        <div class="tile-avatar">
                            <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg">
                            <div class="online-badge ${is_online ? 'active' : ''}"></div>
                        </div>
                        <div class="tile-content">
                            <h4>${user.name}</h4>
                            <p>${user.ph}</p>
                        </div>
                    `;
                    list_div.prepend(tile);
                });
            });
        });
    }

    /* -----------------------------------------------------------
     16. REAL-TIME MESSAGING KERNEL
     -----------------------------------------------------------
    */
    function openInboxEngine(partner_ph, partner_name) {
        ACTIVE_CHAT_PARTNER = partner_ph;
        document.getElementById('ui-target-name').innerText = partner_name;
        document.getElementById('inbox-panel').style.display = 'flex';
        
        const CHAT_CHANNEL_ID = [SYSTEM_USER_ID, partner_ph].sort().join("___");
        
        // TYPING SIGNAL LISTENER
        kernel_db.ref('typing_engine/' + btoa(partner_ph) + '/' + btoa(SYSTEM_USER_ID)).on('value', snap => {
            document.getElementById('ui-typing-indicator').style.display = snap.val() ? 'block' : 'none';
        });

        // FULL MESSAGE SYNC ENGINE
        kernel_db.ref('secure_vault/' + CHAT_CHANNEL_ID).on('value', snap => {
            const scroller = document.getElementById('chat-scroller');
            scroller.innerHTML = "";
            snap.forEach(msg_node => {
                const data = msg_node.val();
                const is_me = data.s === SYSTEM_USER_ID;
                const clock = new Date(data.t).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                scroller.innerHTML += `
                    <div class="message-row ${is_me ? 'me' : 'them'}">
                        <div class="message-bubble">
                            ${data.x}
                            <div class="msg-meta">
                                ${clock} ${is_me ? '<span class="double-tick">‚úî‚úî</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            scroller.scrollTop = scroller.scrollHeight;
        });
    }

    function pushTypingSignal() {
        if (!ACTIVE_CHAT_PARTNER) return;
        kernel_db.ref('typing_engine/' + btoa(SYSTEM_USER_ID) + '/' + btoa(ACTIVE_CHAT_PARTNER)).set(true);
        clearTimeout(TYPING_DEBOUNCE_TIMER);
        TYPING_DEBOUNCE_TIMER = setTimeout(() => {
            kernel_db.ref('typing_engine/' + btoa(SYSTEM_USER_ID) + '/' + btoa(ACTIVE_CHAT_PARTNER)).set(false);
        }, 2500);
    }

    function executeSendMessage() {
        const text = document.getElementById('field-msg').value.trim();
        if (!text || !ACTIVE_CHAT_PARTNER) return;

        const CHAT_CHANNEL_ID = [SYSTEM_USER_ID, ACTIVE_CHAT_PARTNER].sort().join("___");
        const payload = {
            s: SYSTEM_USER_ID,
            x: text,
            t: Date.now()
        };

        kernel_db.ref('secure_vault/' + CHAT_CHANNEL_ID).push(payload).then(() => {
            // Update last active sync
            kernel_db.ref('contacts/' + btoa(SYSTEM_USER_ID) + '/' + btoa(ACTIVE_CHAT_PARTNER)).update({ sync: Date.now() });
            document.getElementById('field-msg').value = "";
            kernel_db.ref('typing_engine/' + btoa(SYSTEM_USER_ID) + '/' + btoa(ACTIVE_CHAT_PARTNER)).set(false);
        });
    }

    /* -----------------------------------------------------------
     17. SYSTEM TERMINATION & UTILS
     -----------------------------------------------------------
    */
    function exitInbox() {
        if (ACTIVE_CHAT_PARTNER) {
            kernel_db.ref('typing_engine/' + btoa(SYSTEM_USER_ID) + '/' + btoa(ACTIVE_CHAT_PARTNER)).set(false);
        }
        document.getElementById('inbox-panel').style.display = 'none';
        ACTIVE_CHAT_PARTNER = null;
    }

    function triggerLogout() {
        if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            kernel_db.ref('online_heartbeat/' + btoa(SYSTEM_USER_ID)).set(false);
            localStorage.clear();
            location.reload();
        }
    }

    // FINAL BOOT LOGS
    console.log("Lal Bilai Engine Booted Successfully...");
    console.log("Security Layer: Active");
    console.log("Real-time Sync: Enabled");

</script>
</body>
</html>
