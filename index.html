<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü - Final Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --red: #D32F2F; --green: #25D366; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #1a1a1a; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #app-wrap { width: 350px; height: 92vh; background: #fff; border-radius: 30px; overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .screen { padding: 30px 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; position: absolute; inset: 0; background: #fff; z-index: 5; display: none; }
        .logo { width: 85px; height: 85px; border-radius: 50%; border: 3px solid var(--red); margin-bottom: 20px; object-fit: cover; }
        input { width: 100%; padding: 13px; margin: 10px 0; border: 1.5px solid #eee; border-radius: 25px; outline: none; text-align: center; font-size: 15px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 25px; background: var(--red); color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .wa-btn { background: var(--green); color: white; text-decoration: none; display: block; width: 100%; padding: 14px; border-radius: 25px; font-weight: bold; margin: 15px 0; }
        header { background: var(--red); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .u-img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        #chat-list { flex: 1; overflow-y: auto; }
        .c-row { padding: 12px 18px; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center; cursor: pointer; }
        .img-box { position: relative; width: 45px; height: 45px; margin-right: 15px; }
        .img-box img { width: 100%; height: 100%; border-radius: 50%; }
        .dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; background: #ccc; }
        .online { background: var(--green); }
        #msg-box { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 8px; padding-bottom: 80px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px; }
        .me { background: #dcf8c6; align-self: flex-end; } .you { background: #fff; align-self: flex-start; }
        .footer { position: absolute; bottom: 0; width: 100%; background: #f0f0f0; padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        .footer input { flex: 1; text-align: left; padding: 10px 15px; margin: 0; }
        .send { background: var(--red); color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }
        .ava-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .ava-item { width: 100%; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
    </style>
</head>
<body>

<div id="app-wrap">
    <div id="login-screen" class="screen" style="display: flex;">
        <img src="https://img.freepik.com/premium-vector/cute-orange-cat-avatar-vector-illustration_1142-40194.jpg" class="logo">
        <h2 style="color:var(--red); margin:0;">‡¶≤‡¶ó‡¶á‡¶®</h2>
        <input type="number" id="l-ph" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
        <input type="password" id="l-ps" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
        <button class="btn" onclick="doLogin()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <p onclick="showForgot()" style="color:var(--red); font-size:13px; cursor:pointer; margin-top:15px; text-decoration:underline;">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</p>
        <p onclick="showReg()" style="color:#666; font-size:13px; cursor:pointer; margin-top:10px;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</p>
    </div>

    <div id="reg-screen" class="screen">
        <h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</h3>
        <input type="number" id="r-ph" placeholder="‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
        <input type="password" id="r-ps" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">
        <button class="btn" onclick="startReg()">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <p onclick="showLogin()" style="color:gray; cursor:pointer;">‡¶™‡¶ø‡¶õ‡¶®‡ßá ‡¶Ø‡¶æ‡¶®</p>
    </div>

    <div id="otp-screen" class="screen">
        <h3 id="otp-title">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h3>
        <p id="otp-hint" style="font-size:12px; color:#666;">‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶™‡ßá‡¶§‡ßá ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡¶ø‡¶®‡•§</p>
        <a href="https://wa.me/9660558687975" target="_blank" class="wa-btn">üí¨ WhatsApp ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶° ‡¶®‡¶ø‡¶®</a>
        <input type="number" id="otp-val" placeholder="‡ß™ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø">
        <button class="btn" onclick="verifyOTP()">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="main-app" style="display:none; flex-direction:column; height:100%;">
        <header>
            <div style="display:flex; align-items:center;">
                <img id="my-ava" src="" class="u-img" onclick="openAva()">
                <span style="margin-left:10px; font-weight:bold;">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</span>
            </div>
            <span onclick="logout()" style="font-size:11px; cursor:pointer;">‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</span>
        </header>
        <div id="chat-list"></div>
        <div style="position:absolute; bottom:20px; right:20px; width:55px; height:55px; background:var(--red); color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:25px; cursor:pointer;" onclick="addFriend()">+</div>
    </div>

    <div id="chat-window" style="display:none; flex-direction:column; height:100%; position:absolute; inset:0; background:#fff; z-index:100;">
        <header>
            <span onclick="closeChat()" style="cursor:pointer; font-size:22px;">‚Üê</span>
            <span id="t-num" style="font-size:14px; font-weight:bold;"></span>
            <img id="t-ava" src="" class="u-img">
        </header>
        <div id="msg-box"></div>
        <div class="footer">
            <input type="text" id="m-text" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú...">
            <button class="send" onclick="sendMsg()">üöÄ</button>
        </div>
    </div>

    <div id="ava-modal" class="screen">
        <h3>‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h3>
        <div class="ava-grid" id="ava-grid"></div>
        <button class="btn" style="width:100px; margin-top:20px;" onclick="hideAva()">‡¶¨‡¶®‡ßç‡¶ß</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const catAvatars = ["https://img.freepik.com/premium-vector/cute-orange-cat-avatar-vector-illustration_1142-40194.jpg","https://img.freepik.com/premium-vector/cute-funny-red-cat-flat-style-avatar_762604-184.jpg","https://img.freepik.com/premium-vector/cat-avatar-funny-cute-ginger-kitten-face-isolated-white-background_619106-695.jpg","https://img.freepik.com/premium-vector/cute-kitten-avatar-ginger-cat-head-hand-drawn-vector-illustration_497042-835.jpg","https://img.freepik.com/premium-vector/cat-icon-ginger-cat-head-face-isolated-white-background_619106-697.jpg","https://img.freepik.com/premium-vector/ginger-cat-avatar-cute-cartoon-animal-portrait_497042-921.jpg"];

    let myPhone = localStorage.getItem("lb_phone") || "";
    let flow = ""; 
    let activeChat = "";

    if(myPhone) startApp();

    function showReg() { hideScreens(); document.getElementById('reg-screen').style.display='flex'; }
    function showLogin() { hideScreens(); document.getElementById('login-screen').style.display='flex'; }
    function hideScreens() { document.querySelectorAll('.screen').forEach(s => s.style.display='none'); }

    function doLogin() {
        let p = document.getElementById('l-ph').value;
        let s = document.getElementById('l-ps').value;
        db.ref('users/' + p).once('value', snap => {
            if(!snap.exists()) return alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á! ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            if(snap.val().pass === s) { localStorage.setItem("lb_phone", p); location.reload(); }
            else alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!");
        });
    }

    function showForgot() {
        let p = document.getElementById('l-ph').value;
        if(!p) return alert("‡¶Ü‡¶ó‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
        db.ref('users/' + p).once('value', snap => {
            if(!snap.exists()) return alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á! ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®‡•§");
            flow = "forgot";
            sendOTP(p);
        });
    }

    function startReg() {
        let p = document.getElementById('r-ph').value;
        let s = document.getElementById('r-ps').value;
        if(p.length < 10) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®");
        db.ref('users/' + p).once('value', snap => {
            if(snap.exists()) return alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ö‡¶≤‡¶∞‡ßá‡¶°‡¶ø ‡¶Ü‡¶õ‡ßá! ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            flow = "reg";
            sendOTP(p, s);
        });
    }

    function sendOTP(p, s="") {
        let code = Math.floor(1000 + Math.random()*9000).toString();
        db.ref('admin_otp/' + p).set({ code: code, pass: s, flow: flow });
        hideScreens();
        document.getElementById('otp-screen').style.display='flex';
        document.getElementById('otp-title').innerText = flow === "reg" ? "‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®" : "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü";
    }

    function verifyOTP() {
        let p = flow === "reg" ? document.getElementById('r-ph').value : document.getElementById('l-ph').value;
        let c = document.getElementById('otp-val').value;
        db.ref('admin_otp/' + p).once('value', snap => {
            if(snap.val() && snap.val().code === c) {
                if(flow === "reg") {
                    db.ref('users/' + p).set({ pass: snap.val().pass, profilePic: catAvatars[0], status: 'online' });
                    localStorage.setItem("lb_phone", p); location.reload();
                } else {
                    let n = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:");
                    if(n) { db.ref('users/' + p).update({ pass: n }); alert("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡¶¶‡¶≤‡ßá‡¶õ‡ßá!"); location.reload(); }
                }
            } else alert("‡¶≠‡ßÅ‡¶≤ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø!");
        });
    }

    function startApp() {
        hideScreens(); document.getElementById('main-app').style.display='flex';
        db.ref('users/' + myPhone + '/status').set('online');
        db.ref('users/' + myPhone + '/status').onDisconnect().set('offline');
        db.ref('users/' + myPhone + '/profilePic').on('value', s => document.getElementById('my-ava').src = s.val());
        loadL();
        const grid = document.getElementById('ava-grid');
        catAvatars.forEach(url => {
            let img = document.createElement('img');
            img.src = url; img.className = 'ava-item';
            img.onclick = () => { db.ref('users/' + myPhone).update({ profilePic: url }); hideAva(); };
            grid.appendChild(img);
        });
    }

    function loadL() {
        db.ref('my_contacts/' + myPhone).on('value', snap => {
            let list = document.getElementById('chat-list'); list.innerHTML = "";
            snap.forEach(c => {
                db.ref('users/' + c.key).on('value', u => {
                    let d = u.val(); let st = d.status === 'online' ? 'online' : '';
                    list.innerHTML += `<div class="c-row" onclick="openChat('${c.key}')"><div class="img-box"><img src="${d.profilePic}"><div class="dot ${st}"></div></div><span>${c.key}</span></div>`;
                });
            });
        });
    }

    function openChat(n) {
        activeChat = n; document.getElementById('chat-window').style.display='flex';
        document.getElementById('t-num').innerText = n;
        db.ref('users/' + n + '/profilePic').once('value', s => document.getElementById('t-ava').src = s.val());
        listenM();
    }

    function sendMsg() {
        let t = document.getElementById('m-text').value; if(!t) return;
        let cid = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + cid).push({ s: myPhone, m: t, t: Date.now(), seen: false });
        db.ref('my_contacts/' + myPhone + '/' + activeChat).set(true);
        db.ref('my_contacts/' + activeChat + '/' + myPhone).set(true);
        document.getElementById('m-text').value = "";
    }

    function listenM() {
        let cid = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + cid).off();
        db.ref('chats/' + cid).on('value', snap => {
            let box = document.getElementById('msg-box'); box.innerHTML = "";
            snap.forEach(m => {
                let d = m.val(); let side = d.s === myPhone ? 'me' : 'you';
                if(side === 'you' && !d.seen) db.ref('chats/' + cid + '/' + m.key).update({ seen: true });
                box.innerHTML += `<div class="msg ${side}">${d.m}${side==='me'&&d.seen?' <small style="color:blue">‚úì‚úì</small>':''}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    function openAva() { hideScreens(); document.getElementById('ava-modal').style.display='flex'; }
    function hideAva() { document.getElementById('ava-modal').style.display='none'; }
    function closeChat() { document.getElementById('chat-window').style.display='none'; }
    function addFriend() { let n = prompt("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞:"); if(n && n !== myPhone) db.ref('users/' + n).once('value', s => { if(s.exists()){ db.ref('my_contacts/' + myPhone + '/' + n).set(true); openChat(n); }else alert("‡¶®‡ßá‡¶á!"); }); }
    function logout() { db.ref('users/' + myPhone + '/status').set('offline'); localStorage.clear(); location.reload(); }
</script>
</body>
</html>
