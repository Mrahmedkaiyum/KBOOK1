<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lal Bilai - Advanced Global Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root {
            --whatsapp-main: #25D366;
            --whatsapp-dark: #075E54;
            --whatsapp-teal: #128C7E;
            --chat-bg: #e5ddd5;
            --white: #ffffff;
            --black: #000000;
            --gray: #f0f2f5;
            --bubble-sent: #dcf8c6;
            --bubble-rec: #ffffff;
            --text-dark: #303030;
            --text-light: #777;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #1a1a1a;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* App Layout Frame */
        #app-container {
            width: 100%;
            max-width: 480px;
            height: 96vh;
            background: var(--white);
            position: relative;
            display: flex;
            flex-direction: column;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            border: 4px solid #333;
        }

        /* --- AUTHENTICATION STYLES --- */
        .auth-view {
            position: absolute;
            inset: 0;
            background: var(--white);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            padding: 40px 30px;
            align-items: center;
            text-align: center;
            transition: transform 0.5s ease-in-out;
        }

        .auth-logo {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: 5px solid var(--whatsapp-main);
            margin-bottom: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            object-fit: cover;
        }

        .auth-card {
            width: 100%;
            background: var(--gray);
            padding: 25px;
            border-radius: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        h2 { color: var(--whatsapp-dark); margin-bottom: 20px; font-size: 24px; }

        .form-group { width: 100%; margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-light); font-size: 13px; margin-left: 10px; }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid transparent;
            border-radius: 12px;
            outline: none;
            font-size: 16px;
            background: var(--white);
            transition: all 0.3s;
        }

        input:focus {
            border-color: var(--whatsapp-main);
            box-shadow: 0 0 10px rgba(37, 211, 102, 0.2);
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            background: var(--whatsapp-main);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.3s;
        }

        .action-btn:active { transform: scale(0.98); background: var(--whatsapp-teal); }

        .switch-mode {
            margin-top: 20px;
            color: var(--whatsapp-dark);
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }

        /* --- MESSENGER UI STYLES --- */
        header {
            background: var(--whatsapp-dark);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            height: 75px;
            flex-shrink: 0;
            z-index: 100;
        }

        .profile-thumb {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
            object-fit: cover;
        }

        .brand-name { flex: 1; font-size: 22px; font-weight: bold; letter-spacing: 0.5px; }

        .nav-icons { display: flex; gap: 18px; font-size: 22px; }
        .nav-icons span { cursor: pointer; transition: 0.2s; }
        .nav-icons span:hover { opacity: 0.8; }

        /* User List View */
        #main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff;
        }

        #chat-list-area {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f1f1f1;
            cursor: pointer;
            transition: 0.3s;
        }

        .contact-item:hover { background: #f9f9f9; }

        .avatar-box { position: relative; width: 55px; height: 55px; }
        .avatar-box img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .status-dot {
            position: absolute;
            right: 2px;
            bottom: 2px;
            width: 14px;
            height: 14px;
            background: #ccc;
            border: 2px solid #fff;
            border-radius: 50%;
        }
        .status-dot.online { background: var(--whatsapp-main); }

        .contact-info { flex: 1; margin-left: 15px; }
        .contact-info h4 { font-size: 17px; color: var(--text-dark); margin-bottom: 4px; }
        .contact-info p { font-size: 14px; color: var(--text-light); }

        /* --- FULL SCREEN INBOX --- */
        #inbox-view {
            position: absolute;
            inset: 0;
            background: var(--chat-bg);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        #message-display {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }

        .msg-row { display: flex; width: 100%; }
        .msg-row.my-msg { justify-content: flex-end; }
        .msg-row.their-msg { justify-content: flex-start; }

        .bubble {
            max-width: 80%;
            padding: 10px 15px;
            font-size: 15px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .my-msg .bubble {
            background: var(--bubble-sent);
            border-radius: 15px 0px 15px 15px;
        }

        .their-msg .bubble {
            background: var(--bubble-rec);
            border-radius: 0px 15px 15px 15px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 5px;
            display: block;
            text-align: right;
        }

        .blue-ticks { color: #34B7F1; font-weight: bold; margin-left: 5px; font-size: 12px; }

        /* Footer Input Area */
        .inbox-footer {
            background: #f0f0f0;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        .input-wrapper {
            flex: 1;
            background: white;
            border-radius: 25px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            height: 48px;
            border: 1px solid #ccc;
        }

        #chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 5px;
            font-size: 16px;
        }

        .send-round-btn {
            width: 48px;
            height: 48px;
            background: var(--whatsapp-dark);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .typing-label { font-size: 11px; color: #aaffaa; font-style: italic; }

        /* Skeleton loader idea */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--whatsapp-main); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="app-container">
    
    <div id="auth-layer" class="auth-view">
        <img id="main-logo" src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="auth-logo">
        <h2 id="auth-heading">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á‡¶§‡ßá</h2>
        
        <div class="auth-card">
            <div id="reg-fields" class="hidden">
                <div class="form-group">
                    <label>‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="reg-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
                </div>
            </div>

            <div class="form-group">
                <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                <input type="number" id="auth-phone" placeholder="‡ß¶‡ßß‡ßÆXXXXXXXX">
            </div>

            <div class="form-group">
                <label>‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                <input type="password" id="auth-pass" placeholder="‡¶ó‡ßã‡¶™‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
            </div>

            <div id="otp-field" class="hidden">
                <div class="form-group">
                    <label>‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ï‡ßã‡¶° (OTP)</label>
                    <input type="number" id="auth-otp" placeholder="‡ß™ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ï‡ßã‡¶°">
                </div>
            </div>

            <button id="main-auth-btn" class="action-btn" onclick="handleAuthProcess()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <div id="auth-toggle" class="switch-mode" onclick="toggleAuthMode()">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        </div>
        <div class="loader" id="auth-loader"></div>
    </div>

    <div id="main-view" style="display:none;">
        <header>
            <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="profile-thumb" onclick="openProfile()">
            <div class="brand-name">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á</div>
            <div class="nav-icons">
                <span onclick="searchUser()">‚ûï</span>
                <span onclick="performLogout()">üö™</span>
            </div>
        </header>

        <div id="chat-list-area">
            <div style="text-align:center; padding:50px; color:#999;">
                <p>‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶≤‡¶æ‡¶∏ (+) ‡¶Ü‡¶á‡¶ï‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            </div>
        </div>
    </div>

    <div id="inbox-view">
        <header>
            <span onclick="exitChat()" style="cursor:pointer; font-size:24px;">‚¨Ö</span>
            <img id="chat-avatar" src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="profile-thumb">
            <div style="flex:1">
                <div id="chat-target-name" style="font-weight:bold; font-size:17px;">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶®‡¶æ‡¶Æ</div>
                <div id="chat-sub-status" class="typing-label" style="display:none;">typing...</div>
            </div>
        </header>

        <div id="message-display">
            </div>

        <div class="inbox-footer">
            <div class="input-wrapper">
                <input type="text" id="chat-input" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="emitTyping()">
            </div>
            <button class="send-round-btn" onclick="commitMessage()">‚û§</button>
        </div>
    </div>

</div>

<script>
    // --- FIREBASE INITIALIZATION ---
    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶†‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- GLOBAL VARIABLES ---
    let currentUserPhone = localStorage.getItem("lb_active_session") ? atob(localStorage.getItem("lb_active_session")) : null;
    let activeChatPhone = null;
    let isRegMode = false;
    let otpSent = false;
    let generatedOTP = null;
    let typingTimer;

    // --- AUTHENTICATION LOGIC ---
    function toggleAuthMode() {
        isRegMode = !isRegMode;
        document.getElementById('auth-heading').innerText = isRegMode ? "‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®" : "‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á‡¶§‡ßá";
        document.getElementById('reg-fields').classList.toggle('hidden', !isRegMode);
        document.getElementById('main-auth-btn').innerText = isRegMode ? "‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®" : "‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('auth-toggle').innerText = isRegMode ? "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®" : "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®";
        // Reset OTP state
        otpSent = false;
        document.getElementById('otp-field').classList.add('hidden');
    }

    function handleAuthProcess() {
        const ph = document.getElementById('auth-phone').value;
        const ps = document.getElementById('auth-pass').value;

        if (ph.length < 10 || ps.length < 4) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!");

        if (!isRegMode) {
            // Login Logic
            database.ref('users/' + btoa(ph)).once('value', snap => {
                if (snap.exists() && snap.val().pass === ps) {
                    completeLogin(ph);
                } else {
                    alert("‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!");
                }
            });
        } else {
            // Registration Logic
            if (!otpSent) {
                generatedOTP = Math.floor(1000 + Math.random() * 9000).toString();
                database.ref('otp_logs/' + ph).set({
                    code: generatedOTP,
                    time: Date.now()
                }).then(() => {
                    otpSent = true;
                    document.getElementById('otp-field').classList.remove('hidden');
                    document.getElementById('main-auth-btn').innerText = "‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ì ‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™";
                    alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°: " + generatedOTP + "\n(‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨‡ßá ‡¶è‡¶ü‡¶ø SMS ‡¶è ‡¶Ø‡ßá‡¶§)");
                });
            } else {
                const userOTP = document.getElementById('auth-otp').value;
                if (userOTP === generatedOTP) {
                    const name = document.getElementById('reg-name').value;
                    database.ref('users/' + btoa(ph)).set({
                        name: name || "User",
                        ph: ph,
                        pass: ps,
                        created: Date.now()
                    }).then(() => {
                        completeLogin(ph);
                    });
                } else {
                    alert("‡¶≠‡ßÅ‡¶≤ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°!");
                }
            }
        }
    }

    function completeLogin(ph) {
        localStorage.setItem("lb_active_session", btoa(ph));
        location.reload();
    }

    // --- MAIN APP INITIALIZATION ---
    if (currentUserPhone) {
        document.getElementById('auth-layer').classList.add('hidden');
        document.getElementById('main-view').style.display = 'flex';
        
        // Mark user as Online
        database.ref('online_status/' + btoa(currentUserPhone)).set(true);
        database.ref('online_status/' + btoa(currentUserPhone)).onDisconnect().set(false);
        
        refreshChatList();
    }

    function searchUser() {
        const ph = prompt("‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if (!ph || ph === currentUserPhone) return;
        
        database.ref('users/' + btoa(ph)).once('value', snap => {
            if (snap.exists()) {
                const userData = snap.val();
                // Add to contacts
                database.ref('contacts/' + btoa(currentUserPhone) + '/' + btoa(ph)).set({
                    name: userData.name,
                    ph: ph,
                    lastInteraction: Date.now()
                }).then(() => {
                    launchInbox(ph, userData.name);
                });
            } else {
                alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á‡¶§‡ßá ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶®‡ßü!");
            }
        });
    }

    function refreshChatList() {
        database.ref('contacts/' + btoa(currentUserPhone)).orderByChild('lastInteraction').on('value', snap => {
            const listArea = document.getElementById('chat-list-area');
            listArea.innerHTML = "";
            
            let users = [];
            snap.forEach(child => {
                users.unshift(child.val()); // Newest on top
            });

            if (users.length === 0) {
                listArea.innerHTML = '<div style="text-align:center; padding:50px; color:#999;"><p>‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p></div>';
                return;
            }

            users.forEach(u => {
                // Online status listener for each contact
                database.ref('online_status/' + btoa(u.ph)).on('value', stSnap => {
                    const isOnline = stSnap.val() === true;
                    const existingRow = document.getElementById('row-' + btoa(u.ph));
                    if (existingRow) existingRow.remove();

                    const row = document.createElement('div');
                    row.id = 'row-' + btoa(u.ph);
                    row.className = 'contact-item';
                    row.onclick = () => launchInbox(u.ph, u.name);
                    row.innerHTML = `
                        <div class="avatar-box">
                            <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg">
                            <div class="status-dot ${isOnline ? 'online' : ''}"></div>
                        </div>
                        <div class="contact-info">
                            <h4>${u.name}</h4>
                            <p>${u.ph}</p>
                        </div>
                    `;
                    listArea.prepend(row);
                });
            });
        });
    }

    // --- REAL-TIME INBOX ENGINE ---
    function launchInbox(ph, name) {
        activeChatPhone = ph;
        document.getElementById('chat-target-name').innerText = name;
        document.getElementById('inbox-view').style.display = 'flex';
        
        const chatRoomId = generateChatId(currentUserPhone, ph);
        
        // 1. Listen for "Typing"
        database.ref('typing_signal/' + btoa(ph) + '/' + btoa(currentUserPhone)).on('value', s => {
            document.getElementById('chat-sub-status').style.display = s.val() ? 'block' : 'none';
        });

        // 2. Load Messages and Listen for New Ones
        database.ref('secure_chats/' + chatRoomId).on('value', snap => {
            const display = document.getElementById('message-display');
            display.innerHTML = "";
            
            snap.forEach(msgSnap => {
                const msg = msgSnap.val();
                const isMine = msg.sender === currentUserPhone;
                
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                display.innerHTML += `
                    <div class="msg-row ${isMine ? 'my-msg' : 'their-msg'}">
                        <div class="bubble">
                            ${msg.text}
                            <span class="msg-time">${time} ${isMine ? '<span class="blue-ticks">‚úî‚úî</span>' : ''}</span>
                        </div>
                    </div>
                `;
            });
            display.scrollTop = display.scrollHeight;
        });
    }

    function generateChatId(p1, p2) {
        return [btoa(p1), btoa(p2)].sort().join("_X_");
    }

    function emitTyping() {
        if (!activeChatPhone) return;
        database.ref('typing_signal/' + btoa(currentUserPhone) + '/' + btoa(activeChatPhone)).set(true);
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            database.ref('typing_signal/' + btoa(currentUserPhone) + '/' + btoa(activeChatPhone)).set(false);
        }, 2000);
    }

    function commitMessage() {
        const text = document.getElementById('chat-input').value.trim();
        if (!text || !activeChatPhone) return;

        const chatRoomId = generateChatId(currentUserPhone, activeChatPhone);
        const msgData = {
            sender: currentUserPhone,
            text: text,
            timestamp: Date.now()
        };

        database.ref('secure_chats/' + chatRoomId).push(msgData).then(() => {
            // Update last interaction for both users to keep chat on top
            database.ref('contacts/' + btoa(currentUserPhone) + '/' + btoa(activeChatPhone)).update({ lastInteraction: Date.now() });
            database.ref('contacts/' + btoa(activeChatPhone) + '/' + btoa(currentUserPhone)).update({ 
                name: "User_" + currentUserPhone.slice(-4), // Fallback name
                ph: currentUserPhone,
                lastInteraction: Date.now() 
            });
            
            document.getElementById('chat-input').value = "";
            database.ref('typing_signal/' + btoa(currentUserPhone) + '/' + btoa(activeChatPhone)).set(false);
        });
    }

    function exitChat() {
        document.getElementById('inbox-view').style.display = 'none';
        if (activeChatPhone) {
            database.ref('typing_signal/' + btoa(currentUserPhone) + '/' + btoa(activeChatPhone)).set(false);
            const chatRoomId = generateChatId(currentUserPhone, activeChatPhone);
            database.ref('secure_chats/' + chatRoomId).off(); // Stop listening when exiting
        }
        activeChatPhone = null;
    }

    function performLogout() {
        if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            database.ref('online_status/' + btoa(currentUserPhone)).set(false);
            localStorage.clear();
            location.reload();
        }
    }

    function openProfile() {
        alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: " + currentUserPhone + "\n‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá!");
    }

</script>
</body>
</html>
