<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lal Bilai - Premium Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --main: #25D366; --dark: #075E54; --bg: #ffffff; --light-bg: #f4f7f6; --red: #D32F2F; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        #app-wrap { width: 100%; max-width: 450px; height: 100vh; background: var(--bg); position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5); }

        /* Splash Screen */
        .splash { position: absolute; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .splash-logo { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--main); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Custom Alert */
        #custom-alert { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .alert-box { background: #fff; padding: 20px; border-radius: 15px; width: 85%; text-align: center; border-bottom: 5px solid var(--main); animation: slideUp 0.3s; }

        /* General Screens */
        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: #fff; z-index: 100; flex-direction: column; }
        .visible { display: flex; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Login & Register Styles */
        .auth-container { padding: 30px; display: flex; flex-direction: column; gap: 12px; justify-content: center; height: 100%; animation: slideUp 0.5s; }
        .lang-switch { display: flex; justify-content: flex-end; gap: 10px; font-weight: bold; color: var(--dark); cursor: pointer; margin-bottom: 10px; }
        
        input { padding: 15px; border-radius: 12px; border: 1px solid #ddd; outline: none; font-size: 15px; background: var(--light-bg); transition: 0.3s; }
        input:focus { border-color: var(--main); background: #fff; box-shadow: 0 0 8px rgba(37, 211, 102, 0.2); }
        
        .btn { padding: 15px; border-radius: 12px; border: none; background: var(--main); color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 5px; }
        .btn:active { transform: scale(0.96); }

        /* Header & Chat History */
        .header { background: var(--dark); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: #ddd; margin-right: 15px; border: 2px solid var(--main); }

        /* Chat Window (WhatsApp Style) */
        #chat-win { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; }
        .sent { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .rec { align-self: flex-start; background: #fff; border-top-left-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tick { font-size: 10px; margin-left: 5px; color: #999; }
        .seen { color: #34B7F1 !important; }

        /* Bottom Navbar */
        nav { height: 70px; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 500; }
        .nav-tab { text-align: center; color: #888; font-size: 11px; cursor: pointer; flex: 1; }
        .nav-active { color: var(--main); font-weight: bold; }

        .powered { font-size: 10px; color: #aaa; text-align: center; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="app-wrap">
    <div id="splash" class="splash">
        <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="splash-logo">
        <div style="font-weight: bold; margin-top: 15px; color: var(--dark);">LAL BILAI</div>
        <div class="powered">Powered by KAIYUM</div>
    </div>

    <div id="custom-alert">
        <div class="alert-box">
            <p id="alert-msg"></p>
            <button class="btn" style="width: 80px;" onclick="closeAlert()">Ok</button>
        </div>
    </div>

    <div id="scr-auth" class="screen">
        <div class="auth-container">
            <div class="lang-switch">
                <span onclick="toggleLang('en')" id="en-btn">English</span> | 
                <span onclick="toggleLang('bn')" id="bn-btn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
            </div>
            <h2 id="auth-title" style="color: var(--dark); margin: 0;">Login</h2>
            <p id="auth-subtitle" style="font-size: 13px; color: #666; margin-bottom: 10px;">Welcome back to Lal Bilai</p>
            
            <input type="text" id="reg-name" placeholder="Full Name" style="display: none;">
            <input type="number" id="auth-ph" placeholder="Mobile Number (Max 11)" oninput="if(this.value.length > 11) this.value = this.value.slice(0,11);">
            <input type="password" id="auth-ps" placeholder="Password">
            
            <button class="btn" id="main-auth-btn" onclick="processAuth()">Sign In</button>
            <p id="switch-mode-text" style="text-align: center; font-size: 14px; cursor: pointer; color: var(--dark);" onclick="switchAuthMode()">Don't have an account? Register</p>
            <p id="forget-pass" style="text-align: center; font-size: 12px; color: var(--red); cursor: pointer;" onclick="forgetPassword()">Forgot Password?</p>
        </div>
    </div>

    <div id="scr-otp" class="screen">
        <div class="auth-container">
            <h2 style="margin: 0;">Verify Code</h2>
            <p style="font-size: 13px; color: #666;">Get OTP from Admin via WhatsApp</p>
            <input type="number" id="otp-input" placeholder="4 Digit OTP" style="text-align: center; letter-spacing: 15px; font-size: 24px;">
            <button class="btn" onclick="verifyOTPCode()">Verify & Finish</button>
            <button class="btn" style="background: #666;" onclick="showScreen('scr-auth')">Back</button>
        </div>
    </div>

    <div id="scr-main" class="screen">
        <div class="header">
            <span>Lal Bilai</span>
            <span onclick="addNewFriend()" style="font-size: 20px;">‚ûï</span>
        </div>
        <div class="chat-list" id="main-chat-list">
            <p style="text-align: center; color: #999; margin-top: 50px;">No chats yet. Add a friend!</p>
        </div>
        <nav>
            <div class="nav-tab nav-active">üí¨<br>Chats</div>
            <div class="nav-tab" onclick="showAlert('Settings coming soon!')">‚öôÔ∏è<br>Settings</div>
        </nav>
    </div>

    <div id="scr-chat" class="screen">
        <div class="header">
            <span onclick="showScreen('scr-main')">‚¨ÖÔ∏è</span>
            <span id="chatting-with">User Name</span>
            <span></span>
        </div>
        <div id="chat-win"></div>
        <div style="padding: 10px; display: flex; gap: 10px; background: #f0f0f0;">
            <input type="text" id="msg-input" placeholder="Type a message..." style="margin-bottom: 0; border-radius: 25px; flex: 1;">
            <button class="btn" style="width: 50px; height: 50px; border-radius: 50%; margin-top: 0;" onclick="sendNewMessage()">üê±</button>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let isLogin = true;
    let currentLang = 'en';
    let myPhone = localStorage.getItem("lb_phone") ? atob(localStorage.getItem("lb_phone")) : null;
    let tempUser = null;
    let activeChatPhone = null;

    // --- Helpers ---
    function showAlert(msg) { document.getElementById('alert-msg').innerText = msg; document.getElementById('custom-alert').style.display = 'flex'; }
    function closeAlert() { document.getElementById('custom-alert').style.display = 'none'; }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible')); document.getElementById(id).classList.add('visible'); }

    // --- Initialization ---
    window.onload = () => {
        setTimeout(() => {
            document.getElementById('splash').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('splash').style.display = 'none';
                if(myPhone) { startApp(); } else { showScreen('scr-auth'); }
            }, 500);
        }, 2500);
    };

    // --- Language & Auth Toggle ---
    function switchAuthMode() {
        isLogin = !isLogin;
        document.getElementById('auth-title').innerText = isLogin ? (currentLang === 'en' ? 'Login' : '‡¶≤‡¶ó‡¶á‡¶®') : (currentLang === 'en' ? 'Register' : '‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®');
        document.getElementById('reg-name').style.display = isLogin ? 'none' : 'block';
        document.getElementById('main-auth-btn').innerText = isLogin ? (currentLang === 'en' ? 'Sign In' : '‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®') : (currentLang === 'en' ? 'Sign Up' : '‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
        document.getElementById('switch-mode-text').innerText = isLogin ? (currentLang === 'en' ? "Don't have an account? Register" : "‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®") : (currentLang === 'en' ? "Already have an account? Login" : "‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");
    }

    function toggleLang(l) {
        currentLang = l;
        switchAuthMode(); switchAuthMode(); // Refresh text
    }

    // --- Authentication Logic ---
    function processAuth() {
        const ph = document.getElementById('auth-ph').value;
        const ps = document.getElementById('auth-ps').value;
        const name = document.getElementById('reg-name').value;

        if(ph.length < 10) return showAlert("Invalid Phone!");
        if(ps.length < 4) return showAlert("Short Password!");

        if(isLogin) {
            db.ref('users/' + btoa(ph)).once('value', snap => {
                if(snap.exists() && snap.val().pass === ps) {
                    localStorage.setItem("lb_phone", btoa(ph));
                    location.reload();
                } else showAlert("Incorrect Info!");
            });
        } else {
            if(!name) return showAlert("Enter Name!");
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            tempUser = { ph, ps, name, code };
            db.ref('otp_requests/' + ph).set({ ph, code, time: Date.now() }).then(() => {
                showScreen('scr-otp');
                window.open(`https://wa.me/9660558687975?text=I am ${name}. Need OTP for ${ph}`);
            });
        }
    }

    function verifyOTPCode() {
        const val = document.getElementById('otp-input').value;
        if(val === tempUser.code) {
            db.ref('users/' + btoa(tempUser.ph)).set({
                name: tempUser.name,
                phone: tempUser.ph,
                pass: tempUser.ps,
                joined: Date.now()
            }).then(() => {
                localStorage.setItem("lb_phone", btoa(tempUser.ph));
                location.reload();
            });
        } else showAlert("Wrong OTP!");
    }

    function forgetPassword() {
        const ph = document.getElementById('auth-ph').value;
        if(!ph) return showAlert("Enter Number First!");
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists()) {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                tempUser = { ph, code, reset: true };
                db.ref('otp_requests/' + ph).set({ ph, code, type: 'reset' }).then(() => {
                    showScreen('scr-otp');
                });
            } else showAlert("Not Registered!");
        });
    }

    // --- App Main Logic ---
    function startApp() {
        showScreen('scr-main');
        db.ref('status/' + myPhone).set(true);
        db.ref('status/' + myPhone).onDisconnect().set(false);
        loadChatHistory();
    }

    function addNewFriend() {
        const ph = prompt("Enter Friend's Phone Number:");
        if(!ph) return;
        db.ref('users/' + btoa(ph)).once('value', snap => {
            if(snap.exists()) {
                const u = snap.val();
                if(confirm("Add " + u.name + "?")) {
                    db.ref('contacts/' + btoa(myPhone) + '/' + btoa(ph)).set({ name: u.name, phone: ph });
                    loadChatHistory();
                }
            } else showAlert("User not found!");
        });
    }

    function loadChatHistory() {
        db.ref('contacts/' + btoa(myPhone)).on('value', snap => {
            const list = document.getElementById('main-chat-list');
            list.innerHTML = "";
            snap.forEach(child => {
                const u = child.val();
                list.innerHTML += `
                    <div class="chat-item" onclick="openChat('${u.phone}', '${u.name}')">
                        <div class="user-avatar"></div>
                        <div><b>${u.name}</b><br><small>${u.phone}</small></div>
                    </div>`;
            });
        });
    }

    function openChat(ph, name) {
        activeChatPhone = ph;
        document.getElementById('chatting-with').innerText = name;
        showScreen('scr-chat');
        const chatId = [myPhone, ph].sort().join("_");
        
        db.ref('chats/' + chatId).on('value', snap => {
            const win = document.getElementById('chat-win');
            win.innerHTML = "";
            snap.forEach(msg => {
                const m = msg.val();
                const isMe = m.sender === myPhone;
                win.innerHTML += `<div class="msg ${isMe ? 'sent' : 'rec'}">${m.text}</div>`;
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function sendNewMessage() {
        const txt = document.getElementById('msg-input').value;
        if(!txt || !activeChatPhone) return;
        const chatId = [myPhone, activeChatPhone].sort().join("_");
        db.ref('chats/' + chatId).push({
            sender: myPhone,
            text: txt,
            time: Date.now()
        });
        document.getElementById('msg-input').value = "";
    }
</script>
</body>
</html>
