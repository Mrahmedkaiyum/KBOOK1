<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á - Ultimate</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --red: #D32F2F; --white: #fff; --bg: #e5ddd5; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #1a1a1a; display: flex; justify-content: center; align-items: center; height: 100vh; }

        #app-wrap { 
            width: 100%; max-width: 360px; height: 88vh; background: var(--white); 
            position: relative; display: flex; flex-direction: column; overflow: hidden;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        header { background: var(--red); color: white; padding: 10px 15px; display: flex; align-items: center; height: 55px; z-index: 20; }
        .p-img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; margin-right: 10px; }

        #msg-box { flex-grow: 1; overflow-y: auto; padding: 10px; background: var(--bg); display: flex; flex-direction: column; gap: 8px; }

        .bubble { padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 13px; position: relative; cursor: pointer; transition: 0.2s; }
        .bubble:active { background: #eee; }
        .me { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .you { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .msg-info { font-size: 9px; display: flex; justify-content: flex-end; gap: 3px; margin-top: 2px; color: #777; }
        .seen { color: #34B7F1; font-weight: bold; }

        .footer { padding: 8px; background: #f0f0f0; display: flex; align-items: center; gap: 8px; }
        .footer input { flex: 1; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; }

        /* ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ */
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: #fff; width: 100%; max-width: 280px; border-radius: 12px; padding: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .m-btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .m-red { background: #ffebee; color: #d32f2f; }
        .m-gray { background: #f5f5f5; color: #333; }
    </style>
</head>
<body>

<div id="app-wrap">
    <header>
        <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" class="p-img">
        <div>
            <span id="chat-title" style="font-weight:bold; font-size:14px; display:block;">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</span>
            <span id="chat-status" style="font-size:9px; opacity:0.8;">‡¶è‡¶ï‡¶ü‡¶ø‡¶≠</span>
        </div>
    </header>

    <div id="msg-box"></div>

    <div class="footer">
        <input type="text" id="m-input" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
        <button onclick="sendMsg()" style="background:var(--red); color:white; border:none; width:36px; height:36px; border-radius:50%; cursor:pointer;">üöÄ</button>
    </div>

    <div id="delete-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <p style="margin:0 0 15px 0; font-weight:bold; text-align:center;">‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <button class="m-btn m-red" id="btn-del-all">‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü (‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá)</button>
            <button class="m-btn m-gray" id="btn-del-me">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá
    let myPhone = localStorage.getItem("lb_phone") || "017xxx"; 
    let activeChat = "chat_room_1"; // ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶Ü‡¶á‡¶°‡¶ø
    let selectedMsgId = null;

    function sendMsg() {
        let t = document.getElementById('m-input').value;
        if(!t) return;
        
        let msgId = Date.now();
        let encText = btoa(unescape(encodeURIComponent(t))); // ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü
        
        let msgData = {
            id: msgId,
            s: myPhone,
            m: encText,
            t: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            seen: { [myPhone]: true }
        };

        db.ref('messages/' + activeChat + '/' + msgId).set(msgData);
        document.getElementById('m-input').value = "";
    }

    // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ì ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
    db.ref('messages/' + activeChat).on('value', snap => {
        let box = document.getElementById('msg-box');
        box.innerHTML = "";
        
        snap.forEach(m => {
            let d = m.val();
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü (Hide) ‡¶ï‡¶∞‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
            if(!d.hide || !d.hide[myPhone]) {
                let isMe = d.s === myPhone;
                let text = decodeURIComponent(escape(atob(d.m)));
                let seenMark = Object.keys(d.seen || {}).length > 1 ? '<span class="seen">‚úì‚úì</span>' : '‚úì';

                box.innerHTML += `
                    <div class="bubble ${isMe ? 'me' : 'you'}" 
                         onclick="openMenu('${d.id}', '${d.s}')" 
                         oncontextmenu="event.preventDefault(); openMenu('${d.id}', '${d.s}')">
                        ${text}
                        <div class="msg-info">${d.t} ${isMe ? seenMark : ''}</div>
                    </div>
                `;

                // ‡¶Ö‡¶ü‡ßã ‡¶∏‡¶ø‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                if(!isMe && (!d.seen || !d.seen[myPhone])) {
                    db.ref('messages/' + activeChat + '/' + d.id + '/seen/' + myPhone).set(true);
                }
            }
        });
        box.scrollTop = box.scrollHeight;
    });

    function openMenu(msgId, sender) {
        selectedMsgId = msgId;
        document.getElementById('delete-modal').style.display = 'flex';
        
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú '‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø' ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá
        document.getElementById('btn-del-all').style.display = (sender === myPhone) ? 'block' : 'none';
        
        document.getElementById('btn-del-all').onclick = () => {
            // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
            db.ref('messages/' + activeChat + '/' + selectedMsgId).remove();
            closeMenu();
        };

        document.getElementById('btn-del-me').onclick = () => {
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶≠‡¶ø‡¶â ‡¶•‡ßá‡¶ï‡ßá ‡¶π‡¶æ‡¶á‡¶° (‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá)
            db.ref('messages/' + activeChat + '/' + selectedMsgId + '/hide/' + myPhone).set(true);
            closeMenu();
        };
    }

    function closeMenu() { document.getElementById('delete-modal').style.display = 'none'; }
</script>

</body>
</html>
