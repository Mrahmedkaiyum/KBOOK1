<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü - Final Version</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --red: #D32F2F; --bg: #f0f2f5; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #ddd; height: 100vh; display: flex; justify-content: center; }
        
        #app-wrap { width: 100%; max-width: 450px; height: 100vh; background: white; position: relative; display: flex; flex-direction: column; }

        /* Auth/Login */
        .auth-page { padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .app-logo { width: 100px; height: 100px; border-radius: 20px; margin-bottom: 15px; border: 2px solid var(--red); object-fit: cover; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 25px; outline: none; text-align: center; font-size: 16px; }
        .btn { width: 90%; padding: 14px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; color: white; background: var(--red); font-size: 16px; }

        /* Header */
        header { background: var(--red); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; min-height: 55px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .small-logo { width: 32px; height: 32px; border-radius: 5px; object-fit: cover; }
        
        /* Main Screen & Chat List */
        #main-screen { display: none; flex-direction: column; height: 100%; }
        #chat-list { flex: 1; overflow-y: auto; background: white; }
        .contact-row { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 500; display: flex; align-items: center; }
        .contact-row:active { background: #f9f9f9; }

        /* Private Chat Window */
        #private-chat { position: absolute; inset: 0; background: white; z-index: 1000; display: none; flex-direction: column; }
        #msg-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #e5ddd5; padding-bottom: 70px; }
        
        /* Bubble Styles */
        .bubble { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px; line-height: 1.5; word-wrap: break-word; position: relative; }
        .sent { background: #dcf8c6; color: #333; align-self: flex-end; border-top-right-radius: 2px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .received { background: white; color: #333; align-self: flex-start; border-top-left-radius: 2px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }

        /* Footer (Pinned at Bottom) */
        .chat-footer { position: absolute; bottom: 0; width: 100%; background: #f0f0f0; padding: 10px; display: flex; gap: 8px; align-items: center; border-top: 1px solid #ccc; }
        .chat-footer input { flex: 1; text-align: left; padding: 10px 15px; margin: 0; background: white; border: 1px solid #ddd; border-radius: 20px; }
        .send-btn { background: var(--red); color: white; border: none; border-radius: 50%; width: 42px; height: 42px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        .fab { position: absolute; bottom: 30px; right: 20px; width: 55px; height: 55px; background: var(--red); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="app-wrap">
    <div id="auth-box" class="auth-page">
        <img src="https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg" class="app-logo">
        <h2 style="color:var(--red); margin: 0 0 20px 0;">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</h2>
        <div id="login-form">
            <input type="number" id="phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®">
            <input type="password" id="pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®">
            <button class="btn" onclick="requestOTP()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ / ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®</button>
        </div>
        <div id="otp-form" style="display:none;">
            <p style="font-size:14px;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶° ‡¶®‡¶ø‡ßü‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶¨‡¶∏‡¶æ‡¶®</p>
            <input type="number" id="otp-input" placeholder="‡ß™ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡ßã‡¶°">
            <button class="btn" onclick="finalizeAuth()">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div id="main-screen">
        <header>
            <div style="display:flex; align-items:center;">
                <img src="https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg" class="small-logo">
                <span style="margin-left:10px;">‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</span>
            </div>
            <span onclick="logout()" style="cursor:pointer; font-size:12px;">‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</span>
        </header>
        <div id="chat-list"></div>
        <div class="fab" onclick="addNewContact()">+</div>
    </div>

    <div id="private-chat">
        <header>
            <div style="display:flex; align-items:center;">
                <span onclick="closeChat()" style="cursor:pointer; padding:5px 10px; font-size:20px;">‚Üê</span>
                <span id="chat-target">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</span>
            </div>
            <img src="https://major-yellow-owkufws56f.edgeone.app/Screenshot_20260202-193254.jpg" class="small-logo">
        </header>
        
        <div id="msg-box"></div> <div class="chat-footer">
            <input type="text" id="m-text" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
            <button class="send-btn" onclick="sendMsg()">üöÄ</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://kbook-5d175-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myPhone = localStorage.getItem("lb_phone") || "";
    let myDeviceID = localStorage.getItem("lb_device") || "";
    let activeChat = "";

    if(myPhone && myDeviceID) checkDevice();

    function requestOTP() {
        myPhone = document.getElementById('phone').value;
        let p = document.getElementById('pass').value;
        if(myPhone.length < 10) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®");
        let otp = Math.floor(1000 + Math.random() * 9000).toString();
        db.ref('admin_notifications/' + myPhone).set({ phone: myPhone, otp: otp, time: Date.now() });
        db.ref('verification/' + myPhone).update({ otp: otp, temp_pass: p });
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('otp-form').style.display = 'block';
        alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® (+9660558687975) ‡¶•‡ßá‡¶ï‡ßá ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶®‡¶ø‡¶®‡•§");
    }

    function finalizeAuth() {
        let code = document.getElementById('otp-input').value;
        db.ref('verification/' + myPhone).once('value', snap => {
            if(snap.val() && snap.val().otp === code) {
                let devId = Math.random().toString(36).substring(7);
                localStorage.setItem("lb_phone", myPhone);
                localStorage.setItem("lb_device", devId);
                db.ref('users/' + myPhone).update({ deviceID: devId, pass: snap.val().temp_pass, status: 'online' });
                location.reload();
            } else { alert("‡¶≠‡ßÅ‡¶≤ ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø!"); }
        });
    }

    function checkDevice() {
        db.ref('users/' + myPhone + '/deviceID').on('value', snap => {
            if(snap.val() !== myDeviceID) { logout(); }
            else {
                document.getElementById('auth-box').style.display = 'none';
                document.getElementById('main-screen').style.display = 'flex';
                loadSavedContacts(); // ‡¶Ü‡¶ó‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá
            }
        });
    }

    function logout() { localStorage.clear(); location.reload(); }

    function addNewContact() {
        let target = prompt("‡¶Ø‡¶æ‡¶ï‡ßá ‡¶è‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if(!target || target === myPhone) return;
        db.ref('users/' + target).once('value', snap => {
            if(snap.exists()) { 
                db.ref('my_contacts/' + myPhone + '/' + target).set(true);
                openChat(target); 
            } else { alert("‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶æ‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á!"); }
        });
    }

    function loadSavedContacts() {
        db.ref('my_contacts/' + myPhone).on('value', snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snap.forEach(c => {
                let num = c.key;
                list.innerHTML += `<div class="contact-row" onclick="openChat('${num}')">üë§ ${num}</div>`;
            });
        });
    }

    function openChat(num) {
        activeChat = num;
        document.getElementById('private-chat').style.display = 'flex';
        document.getElementById('chat-target').innerText = num;
        listenMsgs();
    }

    function closeChat() { document.getElementById('private-chat').style.display = 'none'; }

    function sendMsg() {
        let text = document.getElementById('m-text').value;
        if(!text) return;
        let cid = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + cid).push({ s: myPhone, m: text, t: Date.now() });
        db.ref('my_contacts/' + myPhone + '/' + activeChat).set(true); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶∏‡ßá‡¶≠ ‡¶∞‡¶æ‡¶ñ‡¶æ
        db.ref('my_contacts/' + activeChat + '/' + myPhone).set(true); // ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶ì ‡¶∏‡ßá‡¶≠ ‡¶∞‡¶æ‡¶ñ‡¶æ
        document.getElementById('m-text').value = "";
    }

    function listenMsgs() {
        let cid = [myPhone, activeChat].sort().join("_");
        db.ref('chats/' + cid).on('value', snap => {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            snap.forEach(c => {
                let d = c.val();
                let side = d.s === myPhone ? 'sent' : 'received';
                box.innerHTML += `<div class="bubble ${side}">${d.m}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }
</script>

</body>
</html>
