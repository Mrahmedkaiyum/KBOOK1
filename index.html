<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lal Bilai Messenger</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
:root{
  --green:#25D366;
  --dark:#075E54;
  --bg:#f0f2f5;
}
*{box-sizing:border-box;font-family:Segoe UI}
body{margin:0;background:#000;display:flex;justify-content:center}
#app{max-width:420px;width:100%;height:100vh;background:#fff;position:relative}

/* screens */
.screen{display:none;height:100%;flex-direction:column}
.show{display:flex}

/* splash */
#splash{justify-content:center;align-items:center}
#splash img{width:120px;border-radius:50%}
#splash p{margin-top:15px;color:#666}

/* header */
.header{background:var(--dark);color:#fff;padding:14px;font-weight:bold}

/* auth */
.form{padding:25px;display:flex;flex-direction:column;gap:12px}
input{padding:12px;border-radius:8px;border:1px solid #ccc}
button{padding:12px;border:none;border-radius:8px;background:var(--green);color:#fff;font-weight:bold}

/* chat */
#chatWin{flex:1;overflow-y:auto;background:#e5ddd5;padding:10px}
.msg{max-width:75%;padding:8px 10px;border-radius:10px;font-size:14px}
.me{background:#dcf8c6;margin-left:auto}
.you{background:#fff}
.tick{font-size:10px;margin-left:4px;color:#999}
.seen{color:#34b7f1}

.bottom{display:flex;padding:8px;background:#f0f0f0}
.bottom input{flex:1;border-radius:20px}
.bottom button{margin-left:6px;border-radius:50%;width:45px}

/* nav */
nav{display:flex;border-top:1px solid #ddd}
nav div{flex:1;text-align:center;padding:10px;cursor:pointer}
.active{color:var(--green);font-weight:bold}
</style>
</head>

<body>
<div id="app">

<!-- SPLASH -->
<div id="splash" class="screen show">
  <img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg">
  <p>Powered by Kaiyum</p>
</div>

<!-- AUTH -->
<div id="auth" class="screen">
  <div class="form">
    <h3 id="authTitle">Login</h3>
    <input id="name" placeholder="Your Name (Register only)">
    <input id="phone" type="number" placeholder="Mobile (10‚Äì11 digit)"
     oninput="if(this.value.length>11)this.value=this.value.slice(0,11)">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="auth()">Continue</button>
    <small onclick="toggle()" style="cursor:pointer">No account? Register</small>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="screen">
  <div class="header">Lal Bilai</div>
  <div id="chatList" style="flex:1;overflow:auto"></div>
  <nav>
    <div class="active" onclick="tab('chat')">üí¨ Chat</div>
    <div onclick="tab('profile')">üë§ Profile</div>
  </nav>
</div>

<!-- CHAT -->
<div id="chat" class="screen">
  <div class="header" onclick="back()">‚¨Ö Back</div>
  <div id="chatWin"></div>
  <div class="bottom">
    <input id="msg" placeholder="Type message">
    <button onclick="send()">üê±</button>
  </div>
</div>

</div>

<script>
// FIREBASE (‡¶§‡ßã‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞‡¶ü‡¶æ‡¶á)
firebase.initializeApp({
  databaseURL:"https://kbook-5d175-default-rtdb.firebaseio.com/"
});
const db=firebase.database();

// GLOBAL
let myPhone=localStorage.lb?atob(localStorage.lb):null;
let isLogin=true,chatWith=null;

// START
setTimeout(()=>{
 if(myPhone){loadMain()}
 else show('auth')
},2000);

// UI
function show(id){
 document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'))
 document.getElementById(id).classList.add('show')
}
function toggle(){
 isLogin=!isLogin
 document.getElementById('authTitle').innerText=isLogin?'Login':'Register'
}
function tab(t){}
function back(){show('main')}

// AUTH
function auth(){
 let p=phone.value,ps=pass.value,n=name.value
 if(p.length<10)return alert("Invalid number")

 let key=btoa(p)
 if(isLogin){
  db.ref('users/'+key).once('value',s=>{
   if(s.exists()&&s.val().pass===ps){
    localStorage.lb=btoa(p);location.reload()
   }else alert("Wrong info")
  })
 }else{
  if(!n)return alert("Name required")
  db.ref('users/'+key).set({
   name:n,phone:p,pass:ps,time:Date.now()
  }).then(()=>{
   localStorage.lb=btoa(p);location.reload()
  })
 }
}

// MAIN
function loadMain(){
 show('main')
 db.ref('status/'+myPhone).set(true)
 db.ref('status/'+myPhone).onDisconnect().set(false)
}

// CHAT
function openChat(p){
 chatWith=p;show('chat')
 let id=[myPhone,p].sort().join('_')
 db.ref('chats/'+id).on('value',s=>{
  chatWin.innerHTML=''
  s.forEach(n=>{
   let m=n.val(),me=m.sender===myPhone
   if(!me&&!m.seen)db.ref('chats/'+id+'/'+n.key).update({seen:true})
   chatWin.innerHTML+=`
   <div class="msg ${me?'me':'you'}">
   ${m.text}
   ${me?`<span class="tick ${m.seen?'seen':''}">‚úî‚úî</span>`:''}
   </div>`
  })
  chatWin.scrollTop=chatWin.scrollHeight
 })
}
function send(){
 if(!msg.value||!chatWith)return
 let id=[myPhone,chatWith].sort().join('_')
 db.ref('chats/'+id).push({
  sender:myPhone,text:msg.value,seen:false,time:Date.now()
 })
 msg.value=''
}
</script>
</body>
</html>
