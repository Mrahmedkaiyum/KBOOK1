<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Lal Bilai Messenger</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
:root{--g:#25D366;--d:#075E54}
*{box-sizing:border-box;font-family:Segoe UI}
body{margin:0;background:#000;display:flex;justify-content:center}
#app{max-width:420px;width:100%;height:100vh;background:#fff}

.screen{display:none;height:100%;flex-direction:column}
.show{display:flex}
.header{background:var(--d);color:#fff;padding:14px;font-weight:bold}
.form{padding:25px;display:flex;flex-direction:column;gap:12px}
input{padding:12px;border-radius:8px;border:1px solid #ccc}
button{padding:12px;border:none;border-radius:8px;background:var(--g);color:#fff;font-weight:bold}
.link{font-size:13px;text-align:center;color:#075E54;cursor:pointer}
</style>
</head>

<body>
<div id="app">

<!-- SPLASH -->
<div id="splash" class="screen show" style="justify-content:center;align-items:center">
<img src="https://image2url.com/r2/default/images/1770055773770-4e97be2e-90a9-48f4-b20b-bb418a6d3c91.jpg" width="120">
<p>Powered by Kaiyum</p>
</div>

<!-- LOGIN -->
<div id="login" class="screen">
<div class="form">
<h3>Login</h3>
<input id="login_id" placeholder="Mobile or Username">
<input id="login_pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<div class="link" onclick="show('forgot')">Forgot Password?</div>
<div class="link" onclick="show('register')">Create new account</div>
</div>
</div>

<!-- REGISTER -->
<div id="register" class="screen">
<div class="form">
<h3>Register</h3>
<input id="r_name" placeholder="Your Name">
<input id="r_user" placeholder="Username (unique)">
<input id="r_phone" type="number" placeholder="Mobile (10–11 digit)" oninput="if(this.value.length>11)this.value=this.value.slice(0,11)">
<input id="r_pass" type="password" placeholder="Password">
<button onclick="checkUsername()">Next</button>
</div>
</div>

<!-- OTP -->
<div id="otp" class="screen">
<div class="form">
<h3>Verify OTP</h3>
<input id="otp_val" placeholder="4 digit OTP">
<button onclick="verifyOTP()">Confirm</button>
</div>
</div>

<!-- MAIN -->
<div id="main" class="screen">
<div class="header">Welcome to Lal Bilai</div>
</div>

</div>

<script>
// FIREBASE
firebase.initializeApp({
 databaseURL:"https://kbook-5d175-default-rtdb.firebaseio.com/"
});
const db=firebase.database();

// GLOBAL
let tempUser=null;
let myPhone=localStorage.lb?atob(localStorage.lb):null;

// START
setTimeout(()=>{
 if(myPhone)show('main')
 else show('login')
},2000);

// UI
function show(id){
 document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'))
 document.getElementById(id).classList.add('show')
}

// REGISTER STEP 1 — username check
function checkUsername(){
 // DOM থেকে value ঠিকভাবে নিয়ে tempUser বানানো
 const n = document.getElementById('r_name').value.trim()
 const u = document.getElementById('r_user').value.trim().toLowerCase()
 const p = document.getElementById('r_phone').value.trim()
 const ps = document.getElementById('r_pass').value.trim()

 if(!n||!u||!ps||p.length<10){
  alert("Please fill all fields correctly (phone 10–11 digits)")
  return
 }

 // username unique check
 db.ref("usernames/"+u).once("value",snap=>{
  if(snap.exists()){
   alert("Username already taken. Choose another one.")
  }else{
   const code=Math.floor(1000+Math.random()*9000).toString()
   tempUser={n,u,p,ps,code} // tempUser ঠিকভাবে set
   db.ref("otp_requests/"+p).set({code})
   show('otp') // OTP screen
  }
 })
}

// REGISTER STEP 2 — OTP verify
function verifyOTP(){
 if(!tempUser)return
 const otpInput = document.getElementById('otp_val').value.trim()
 if(otpInput!==tempUser.code){
  alert("Wrong OTP")
  return
 }

 const phoneKey=btoa(tempUser.p)

 // save user
 db.ref("users/"+phoneKey).set({
  name:tempUser.n,
  username:tempUser.u,
  phone:tempUser.p,
  pass:tempUser.ps,
  joined:Date.now()
 }).then(()=>{
  // reserve username
  db.ref("usernames/"+tempUser.u).set(phoneKey)
  localStorage.lb=phoneKey
  show('main') // OTP confirm হলে main স্ক্রিনে redirect
 })
}

// LOGIN
function login(){
 const id=document.getElementById('login_id').value.trim().toLowerCase()
 const ps=document.getElementById('login_pass').value.trim()

 if(!id||!ps)return

 // check by username
 db.ref("usernames/"+id).once("value",uSnap=>{
  if(uSnap.exists()){
   const phoneKey=uSnap.val()
   db.ref("users/"+phoneKey).once("value",s=>{
    if(s.val().pass===ps){
     localStorage.lb=phoneKey
     show('main')
    }else alert("Wrong password")
   })
  }else{
   // check by phone
   const key=btoa(id)
   db.ref("users/"+key).once("value",s=>{
    if(s.exists()&&s.val().pass===ps){
     localStorage.lb=key
     show('main')
    }else alert("Account not found")
   })
  }
 })
}
</script>
</body>
</html>
